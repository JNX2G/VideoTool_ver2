{% extends 'contents/base.html' %}

{% block title %}{{ title }}{% endblock %}

{% block breadcrumb %}
<nav aria-label="breadcrumb">
    <ol class="breadcrumb">
        <li class="custom-breadcrumb-item">
            <a href="{% url 'prephub:method_list' %}">
                <i class="bi bi-funnel"></i> ì „ì²˜ë¦¬ ê¸°ë²•
            </a>
        </li>
        <li class="custom-breadcrumb-item active">
            <a href="#">
                <i class="bi bi-pencil"></i> {{ title }}
            </a>
        </li>
    </ol>
</nav>
{% endblock breadcrumb %}

{% block content %}
<div class="container" style="max-width: 1200px;">
    <div class="row">
        <!-- ì™¼ìª½: ì…ë ¥ í¼ -->
        <div class="col-md-6">
            <div class="card shadow-sm">
                <div class="card-body p-4">
                    <form method="post" enctype="multipart/form-data">
                        {% csrf_token %}
                        
                        <!-- ê¸°ë³¸ ì •ë³´ -->
                        <div class="mb-4">
                            <h5 class="border-bottom pb-2 mb-3">
                                <i class="bi bi-info-circle"></i> ê¸°ë³¸ ì •ë³´
                            </h5>
                            
                            <div class="mb-3">
                                <label for="{{ form.name.id_for_label }}" class="form-label fw-bold">
                                    ê¸°ë²• ì´ë¦„ <span class="text-danger">*</span>
                                </label>
                                {{ form.name }}
                                {% if form.name.errors %}
                                    <div class="text-danger small">{{ form.name.errors }}</div>
                                {% endif %}
                                <div class="form-text">
                                    <i class="bi bi-arrow-right"></i> 
                                    ì „ì²˜ë¦¬ ì„ íƒ í™”ë©´ì— í‘œì‹œë  ì´ë¦„
                                </div>
                            </div>

                            <div class="mb-3">
                                <label for="{{ form.code.id_for_label }}" class="form-label fw-bold">
                                    ê¸°ë²• ì½”ë“œ <span class="text-danger">*</span>
                                </label>
                                {{ form.code }}
                                {% if form.code.errors %}
                                    <div class="text-danger small">{{ form.code.errors }}</div>
                                {% endif %}
                                <div class="form-text">
                                    <i class="bi bi-arrow-right"></i> 
                                    ì˜ë¬¸ ì†Œë¬¸ì, ìˆ«ì, ì–¸ë”ìŠ¤ì½”ì–´(_)ë§Œ ì‚¬ìš© (ì˜ˆ: my_blur)
                                </div>
                            </div>

                            <div class="mb-3">
                                <label for="{{ form.category.id_for_label }}" class="form-label fw-bold">
                                    ì¹´í…Œê³ ë¦¬ <span class="text-danger">*</span>
                                </label>
                                {{ form.category }}
                                <div class="form-text">
                                    <i class="bi bi-arrow-right"></i> 
                                    ê¸°ë²•ì„ ë¶„ë¥˜í•  ì¹´í…Œê³ ë¦¬ ì„ íƒ
                                </div>
                            </div>

                            <div class="mb-3">
                                <label for="{{ form.description.id_for_label }}" class="form-label fw-bold">
                                    ì„¤ëª…
                                </label>
                                {{ form.description }}
                            </div>
                        </div>

                        <!-- Python íŒŒì¼ -->
                        <div class="mb-4">
                            <h5 class="border-bottom pb-2 mb-3">
                                <i class="bi bi-file-earmark-code"></i> Python íŒŒì¼
                            </h5>
                            
                            <div class="mb-3">
                                <label for="{{ form.python_file.id_for_label }}" class="form-label fw-bold">
                                    Python íŒŒì¼ (.py) <span class="text-danger">*</span>
                                </label>
                                {{ form.python_file }}
                                {% if form.python_file.errors %}
                                    <div class="text-danger small">{{ form.python_file.errors }}</div>
                                {% endif %}
                                <div class="form-text">
                                    <i class="bi bi-arrow-right"></i> 
                                    <strong>ì˜¤ë¥¸ìª½ í…œí”Œë¦¿ì„ ë³µì‚¬</strong>í•˜ì—¬ ì½”ë“œ ì‘ì„± í›„, .py íŒŒì¼ë¡œ ì €ì¥ í›„ ì—…ë¡œë“œí•˜ì„¸ìš”
                                </div>
                            </div>
                            <div class="mb-3">
                                <label for="{{ form.function_name.id_for_label }}" class="form-label fw-bold">
                                    í•¨ìˆ˜ ì´ë¦„
                                </label>
                                {{ form.function_name }}
                                {% if form.function_name.errors %}
                                    <div class="text-danger small">{{ form.function_name.errors }}</div>
                                {% endif %}
                                <div class="form-text">
                                    <i class="bi bi-arrow-right"></i> 
                                    Python íŒŒì¼ ë‚´ì—ì„œ ì‹¤í–‰í•  í•¨ìˆ˜ ì´ë¦„ (ê¸°ë³¸ê°’: process)
                                </div>
                            </div>
                        </div>

                        <!-- íŒŒë¼ë¯¸í„° ì„¤ì • -->
                        <div class="mb-4">
                            <h5 class="border-bottom pb-2 mb-3">
                                <i class="bi bi-sliders"></i> íŒŒë¼ë¯¸í„° ì„¤ì •
                            </h5>

                            <!-- íŒŒë¼ë¯¸í„° ìŠ¤í‚¤ë§ˆ -->
                            <div class="mb-3">
                                <label for="{{ form.parameter_schema.id_for_label }}" class="form-label fw-bold">
                                    íŒŒë¼ë¯¸í„° ìŠ¤í‚¤ë§ˆ (JSON)
                                    <button type="button" class="btn btn-sm btn-outline-primary ms-2" 
                                            onclick="copyToFieldHandler('schema_example', 'id_parameter_schema', this)">
                                        <i class="bi bi-clipboard"></i> ì˜ˆì‹œ ì‚¬ìš©
                                    </button>
                                    <button type="button" class="btn btn-sm btn-outline-danger" 
                                            onclick="clearFieldHandler('id_parameter_schema', this)">
                                        <i class="bi bi-x-circle"></i> ì´ˆê¸°í™”
                                    </button>
                                </label>
                                {{ form.parameter_schema }}
                                <div class="form-text">
                                    <i class="bi bi-arrow-right"></i> 
                                    ê° íŒŒë¼ë¯¸í„°ì˜ <strong>íƒ€ì…, ë²”ìœ„, ì„¤ëª…</strong>ì„ ì •ì˜ â†’ ì „ì²˜ë¦¬ í™”ë©´ì—ì„œ ì…ë ¥ í¼ ìƒì„±
                                </div>
                            </div>

                            <!-- ê¸°ë³¸ íŒŒë¼ë¯¸í„° ê°’ -->
                            <div class="mb-3">
                                <label for="{{ form.default_parameters.id_for_label }}" class="form-label fw-bold">
                                    ê¸°ë³¸ íŒŒë¼ë¯¸í„° ê°’ (JSON)
                                    <button type="button" class="btn btn-sm btn-outline-primary ms-2" 
                                            onclick="copyToFieldHandler('default_example', 'id_default_parameters', this)">
                                        <i class="bi bi-clipboard"></i> ì˜ˆì‹œ ì‚¬ìš©
                                    </button>
                                    <button type="button" class="btn btn-sm btn-outline-danger" 
                                            onclick="clearFieldHandler('id_default_parameters', this)">
                                        <i class="bi bi-x-circle"></i> ì´ˆê¸°í™”
                                    </button>
                                </label>
                                {{ form.default_parameters }}
                                <div class="form-text">
                                    <i class="bi bi-arrow-right"></i> 
                                    ì‚¬ìš©ìê°€ ê°’ì„ ì…ë ¥í•˜ì§€ ì•Šì•˜ì„ ë•Œ ì‚¬ìš©í•  <strong>ì´ˆê¸°ê°’</strong>
                                </div>
                            </div>
                        </div>

                        <!-- ìƒíƒœ -->
                        <div class="mb-4">
                            <div class="form-check">
                                {{ form.is_active }}
                                <label class="form-check-label fw-bold" for="{{ form.is_active.id_for_label }}">
                                    í™œì„±í™”
                                </label>
                                <div class="form-text">
                                    <i class="bi bi-arrow-right"></i> 
                                    ë¹„í™œì„±í™”í•˜ë©´ ì „ì²˜ë¦¬ ì„ íƒ ì‹œ í‘œì‹œë˜ì§€ ì•ŠìŒ
                                </div>
                            </div>
                        </div>

                        <!-- ë²„íŠ¼ -->
                        <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                            <a href="{% url 'prephub:method_list' %}" class="btn btn-outline-secondary">
                                <i class="bi bi-x-circle"></i> ì·¨ì†Œ
                            </a>
                            <button type="submit" class="btn btn-primary">
                                <i class="bi bi-check-circle"></i> {{ button_text }}
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
        
        <!-- ì˜¤ë¥¸ìª½: í…œí”Œë¦¿ ë° ê°€ì´ë“œ -->
        <div class="col-md-6">
            <div class="card bg-light border-0 sticky-top" style="top: 80px;">
                <div class="card-body">
                    
                    <!-- ì…ì¶œë ¥ ëª…ì„¸ -->
                    <div class="card mb-3 bg-white">
                        <div class="card-header bg-primary text-white">
                            <strong>ğŸ“‹ ì…ì¶œë ¥ ëª…ì„¸ (í•„ìˆ˜ ì¤€ìˆ˜!)</strong>
                        </div>
                        <div class="card-body">
                            <h6 class="text-primary">ğŸ“¥ ì…ë ¥ (Input)</h6>
                            <table class="table table-sm table-bordered mb-3">
                                <thead class="table-light">
                                    <tr>
                                        <th width="30%">ì´ë¦„</th>
                                        <th width="30%">íƒ€ì…</th>
                                        <th>ì„¤ëª…</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td><code>frame</code></td>
                                        <td>numpy.ndarray</td>
                                        <td>BGR ì´ë¯¸ì§€ (HÃ—WÃ—3)</td>
                                    </tr>
                                    <tr>
                                        <td><code>**params</code></td>
                                        <td>dict</td>
                                        <td>ì‚¬ìš©ì ì…ë ¥ íŒŒë¼ë¯¸í„°</td>
                                    </tr>
                                </tbody>
                            </table>

                            <h6 class="text-success">ğŸ“¤ ì¶œë ¥ (Output)</h6>
                            <table class="table table-sm table-bordered">
                                <thead class="table-light">
                                    <tr>
                                        <th width="30%">íƒ€ì…</th>
                                        <th>ì„¤ëª…</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td>numpy.ndarray</td>
                                        <td>ì²˜ë¦¬ëœ ì´ë¯¸ì§€</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- ì‚¬ìš© íë¦„ -->
                    <div class="alert alert-success">
                        <h6><i class="bi bi-check-circle"></i> ì‚¬ìš© íë¦„</h6>
                        <ol class="mb-0 small">
                            <li>ì•„ë˜ <strong>Python í…œí”Œë¦¿ ë³µì‚¬</strong></li>
                            <li>í…ìŠ¤íŠ¸ ì—ë””í„°ì— ë¶™ì—¬ë„£ê³  <strong>ìˆ˜ì •</strong></li>
                            <li><code>.py</code> íŒŒì¼ë¡œ <strong>ì €ì¥</strong></li>
                            <li>ì™¼ìª½ í¼ì—ì„œ íŒŒì¼ <strong>ì—…ë¡œë“œ</strong></li>
                            <li>ì•„ë˜ <strong>íŒŒë¼ë¯¸í„° ì˜ˆì‹œ ì‚¬ìš©</strong> ë²„íŠ¼ í´ë¦­ í›„ ì €ì¥</li>
                        </ol>
                    </div>

                    <!-- Python í…œí”Œë¦¿ -->
                    <div class="card mb-3 bg-white">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <strong>ğŸ“„ Python í…œí”Œë¦¿</strong>
                            <button type="button" class="btn btn-sm btn-primary" onclick="copyTemplateHandler('template1', this)">
                                <i class="bi bi-clipboard"></i> ë³µì‚¬
                            </button>
                        </div>
                        <div class="card-body p-0">
<pre id="template1" class="mb-0 p-3" style="font-size: 0.85rem;"><code>"""
ì „ì²˜ë¦¬ ê¸°ë²•: [ê¸°ë²• ì´ë¦„ì„ ì—¬ê¸°ì— ì…ë ¥]
ì‘ì„±ì: [ì‘ì„±ì ì´ë¦„]
ì„¤ëª…: [ì´ ê¸°ë²•ì´ ë¬´ì—‡ì„ í•˜ëŠ”ì§€ ì„¤ëª…]
"""
import cv2
import numpy as np


def process(frame, **params):
    """
    ì „ì²˜ë¦¬ í•¨ìˆ˜ (ì´ í•¨ìˆ˜ëª…ì€ ë³€ê²½í•˜ì§€ ë§ˆì„¸ìš”)
    
    Args:
        frame (numpy.ndarray): BGR ì´ë¯¸ì§€ (HÃ—WÃ—3)
        **params (dict): íŒŒë¼ë¯¸í„° ë”•ì…”ë„ˆë¦¬
    
    Returns:
        numpy.ndarray: ì²˜ë¦¬ëœ ì´ë¯¸ì§€
    """
    # ========================================
    # 1ë‹¨ê³„: íŒŒë¼ë¯¸í„° ê°€ì ¸ì˜¤ê¸°
    # ========================================
    # params.get('íŒŒë¼ë¯¸í„°ëª…', ê¸°ë³¸ê°’) í˜•ì‹ìœ¼ë¡œ ê°€ì ¸ì˜¤ê¸°
    # ì˜ˆ: ksize = params.get('ksize', 5)
    
    # [ì—¬ê¸°ì— íŒŒë¼ë¯¸í„° ì½”ë“œ ì‘ì„±]
    
    
    # ========================================
    # 2ë‹¨ê³„: ì´ë¯¸ì§€ ì²˜ë¦¬ ë¡œì§ ì‘ì„±
    # ========================================
    # frameì„ ì²˜ë¦¬í•˜ì—¬ resultì— ì €ì¥
    # ì˜ˆ: result = cv2.GaussianBlur(frame, (ksize, ksize), 0)
    
    # [ì—¬ê¸°ì— ì²˜ë¦¬ ì½”ë“œ ì‘ì„±]
    result = frame.copy()  # ì´ ì¤„ì„ ì‹¤ì œ ì²˜ë¦¬ ì½”ë“œë¡œ ë³€ê²½
    
    
    # ========================================
    # 3ë‹¨ê³„: ê²°ê³¼ ë°˜í™˜ (ë°˜ë“œì‹œ numpy.ndarray)
    # ========================================
    return result</code></pre>
                        </div>
                    </div>

                    <!-- íŒŒë¼ë¯¸í„° ìŠ¤í‚¤ë§ˆ ì˜ˆì‹œ -->
                    <div class="card mb-3 bg-white">
                        <div class="card-header">
                            <strong>ğŸ“Œ íŒŒë¼ë¯¸í„° ìŠ¤í‚¤ë§ˆ ì˜ˆì‹œ</strong>
                        </div>
                        <div class="card-body p-0">
<pre id="schema_example" class="mb-0 p-3" style="font-size: 0.8rem;"><code>{
  "ksize": {  
    "type": "int",
    "default": 5,
    "min": 1,
    "max": 31,
    "description": "ì»¤ë„ í¬ê¸°"
  }
}</code></pre>
                        </div>
                    </div>

                    <!-- ê¸°ë³¸ íŒŒë¼ë¯¸í„° ê°’ ì˜ˆì‹œ -->
                    <div class="card bg-white">
                        <div class="card-header">
                            <strong>ğŸ“Œ ê¸°ë³¸ íŒŒë¼ë¯¸í„° ê°’ ì˜ˆì‹œ</strong>
                        </div>
                        <div class="card-body p-0">
<pre id="default_example" class="mb-0 p-3" style="font-size: 0.8rem;"><code>{
  "ksize": 5
}</code></pre>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
    </div>
</div>

<script>
// í…œí”Œë¦¿ ë³µì‚¬ (í´ë¦½ë³´ë“œ)
function copyTemplateHandler(elementId, button) {
    const element = document.getElementById(elementId);
    const text = element.textContent;
    
    navigator.clipboard.writeText(text).then(() => {
        const originalHTML = button.innerHTML;
        
        button.innerHTML = '<i class="bi bi-check"></i> ë³µì‚¬ë¨!';
        
        setTimeout(() => {
            button.innerHTML = originalHTML;
        }, 800);
    }).catch(err => {
        console.error('ë³µì‚¬ ì‹¤íŒ¨:', err);
        alert('ë³µì‚¬ ì‹¤íŒ¨: ' + err.message);
    });
}

// ì…ë ¥ í•„ë“œì— ì§ì ‘ ë³µì‚¬
function copyToFieldHandler(sourceId, targetId, button) {
    const sourceElement = document.getElementById(sourceId);
    const text = sourceElement.textContent.trim();
    
    const targetElement = document.getElementById(targetId);
    if (!targetElement) {
        alert('ì…ë ¥ í•„ë“œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤: ' + targetId);
        return;
    }
    
    targetElement.value = text;
    
    const originalHTML = button.innerHTML;
    button.innerHTML = '<i class="bi bi-check"></i> ë³µì‚¬ ì™„ë£Œ';
    
    setTimeout(() => {
        button.innerHTML = originalHTML;
    }, 800);
}

// ì…ë ¥ í•„ë“œ ì´ˆê¸°í™”
function clearFieldHandler(targetId, button) {
    const targetElement = document.getElementById(targetId);
    if (!targetElement) {
        alert('ì…ë ¥ í•„ë“œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤: ' + targetId);
        return;
    }
    
    targetElement.value = '';
    
    const originalHTML = button.innerHTML;
    button.innerHTML = '<i class="bi bi-check"></i> ì´ˆê¸°í™” ì™„ë£Œ';
    
    setTimeout(() => {
        button.innerHTML = originalHTML;
    }, 800);
}
</script>

<style>
/* ë²„íŠ¼ í¬ê¸° ê³ ì • */
.btn-sm {
    min-width: 120px;
}

pre {
    max-height: 400px;
    overflow-y: auto;
    background-color: #f8f9fa;
    border-radius: 4px;
}

pre code {
    font-family: 'Courier New', monospace;
    font-size: 0.85rem;
}

.sticky-top {
    max-height: calc(100vh - 100px);
    overflow-y: auto;
}
</style>
{% endblock %}