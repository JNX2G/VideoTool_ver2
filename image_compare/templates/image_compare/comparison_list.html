{% extends 'contents/base.html' %}

{% block title %}이미지 비교 이력{% endblock %}

{% block breadcrumb_items %}
<li class="custom-breadcrumb-item active">
    <a href="{% url 'image_compare:comparison_list' %}">
        <i class="bi bi-arrow-left-right"></i> 비교 이력
    </a>
</li>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- 필터 및 검색 -->
    <div class="card mb-3 shadow-sm">
        <div class="card-body p-3">
            <div class="row g-2">
                <div class="col-md-8">
                    <form method="get" class="d-flex gap-2">
                        <input type="text" name="search" class="form-control" 
                               placeholder="제목, 이미지 이름으로 검색..." value="{{ search }}">
                        <button type="submit" class="btn btn-primary">
                            <i class="bi bi-search"></i> 
                        </button>
                        {% if search or status_filter %}
                        <a href="{% url 'image_compare:comparison_list' %}" 
                           class="btn btn-outline-secondary">
                            <i class="bi bi-x-circle"></i> 초기화
                        </a>
                        {% endif %}
                    </form>
                </div>
                <div class="col-md-4">
                    <select class="form-select" onchange="location.href='?status=' + this.value + '{% if search %}&search={{ search }}{% endif %}'">
                        <option value="">전체 상태</option>
                        <option value="pending" {% if status_filter == 'pending' %}selected{% endif %}>대기 중</option>
                        <option value="processing" {% if status_filter == 'processing' %}selected{% endif %}>처리 중</option>
                        <option value="completed" {% if status_filter == 'completed' %}selected{% endif %}>완료</option>
                        <option value="failed" {% if status_filter == 'failed' %}selected{% endif %}>실패</option>
                    </select>
                </div>
            </div>
        </div>
    </div>

    <!-- 일괄 작업 툴바 -->
    {% if comparisons %}
    <div class="card mb-3 shadow-sm" id="bulkActionBar" style="display: none;">
        <div class="card-body p-3">
            <div class="d-flex align-items-center justify-content-between">
                <div>
                    <i class="bi bi-check-square text-primary me-2"></i>
                    <span id="selectedCount">0</span>개 선택됨
                </div>
                <div class="d-flex gap-2">
                    <button type="button" class="btn btn-sm btn-outline-secondary" onclick="deselectAll()">
                        <i class="bi bi-x"></i> 선택 해제
                    </button>
                    <button type="button" class="btn btn-sm btn-danger" onclick="bulkDelete()">
                        <i class="bi bi-trash"></i> 선택 항목 삭제
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- 전체 선택 -->
    <div class="mb-3">
        <div class="form-check">
            <input class="form-check-input" type="checkbox" id="selectAll" onchange="toggleSelectAll(this)">
            <label class="form-check-label fw-bold" for="selectAll">
                전체 선택
            </label>
        </div>
    </div>
    {% endif %}

    <!-- 비교 목록 -->
    {% if comparisons %}
    <div class="row row-cols-1 row-cols-md-2 row-cols-lg-3 g-4">
        {% for comparison in comparisons %}
        <div class="col">
            <div class="card h-100 shadow-sm hover-card comparison-card" data-id="{{ comparison.pk }}">
                <!-- 체크박스 (좌측 상단) - 수정됨 -->
                <div class="position-absolute top-0 start-0 m-3" style="z-index: 10;">
                    <input type="checkbox" 
                           class="form-check-input comparison-checkbox" 
                           value="{{ comparison.pk }}"
                           onchange="updateBulkActions()"
                           id="checkbox_{{ comparison.pk }}">
                </div>
                
                <!-- 썸네일: 두 이미지 나란히 -->
                <div class="row g-0" style="height: 150px;">
                    <div class="col-6">
                        <img src="{{ comparison.image_1.file.url }}" 
                             class="h-100 w-100" style="object-fit: cover;" 
                             alt="{{ comparison.image_1.title }}">
                    </div>
                    <div class="col-6">
                        <img src="{{ comparison.image_2.file.url }}" 
                             class="h-100 w-100" style="object-fit: cover;" 
                             alt="{{ comparison.image_2.title }}">
                    </div>
                </div>
                
                <div class="card-body">
                    <h6 class="card-title text-truncate" title="{{ comparison.title }}">
                        {{ comparison.title }}
                    </h6>
                    
                    <!-- 상태 배지 -->
                    <div class="mb-2">
                        <span class="badge 
                            {% if comparison.status == 'completed' %}bg-success
                            {% elif comparison.status == 'failed' %}bg-danger
                            {% elif comparison.status == 'processing' %}bg-warning
                            {% else %}bg-secondary{% endif %}">
                            {{ comparison.get_status_display }}
                        </span>
                        {% if comparison.comparison_method %}
                        <span class="badge bg-light text-dark border">
                            {{ comparison.comparison_method.display_name }}
                        </span>
                        {% endif %}
                    </div>
                    
                    <!-- 유사도 표시 -->
                    {% if comparison.status == 'completed' %}
                    <div class="mb-2">
                        <div class="d-flex justify-content-between align-items-center mb-1">
                            <small class="text-muted">유사도</small>
                            <small class="fw-bold text-success">{{ comparison.get_similarity_percentage }}%</small>
                        </div>
                        <div class="progress" style="height: 8px;">
                            <div class="progress-bar bg-success" role="progressbar" 
                                 style="width: {{ comparison.get_similarity_percentage }}%">
                            </div>
                        </div>
                    </div>
                    {% endif %}
                    
                    <!-- 이미지 정보 -->
                    <p class="card-text small text-muted mb-1">
                        <i class="bi bi-1-circle text-info"></i> {{ comparison.image_1.title|truncatechars:20 }}
                    </p>
                    <p class="card-text small text-muted mb-2">
                        <i class="bi bi-2-circle text-success"></i> {{ comparison.image_2.title|truncatechars:20 }}
                    </p>
                    
                    <p class="card-text small text-muted">
                        <i class="bi bi-clock"></i> {{ comparison.created_at|date:"Y-m-d H:i" }}
                    </p>
                </div>
                
                <div class="card-footer bg-white border-0 pt-0">
                    <div class="d-flex gap-2">
                        <a href="{% url 'image_compare:comparison_result' comparison.pk %}" 
                           class="btn btn-sm btn-primary flex-grow-1">
                            <i class="bi bi-eye"></i> 결과 보기
                        </a>
                        <button type="button" 
                                class="btn btn-sm btn-outline-danger"
                                onclick="deleteComparison({{ comparison.pk }}, '{{ comparison.title|escapejs }}')"
                                title="삭제">
                            <i class="bi bi-trash"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>

    <!-- 페이지네이션 -->
    {% if page_obj.has_other_pages %}
    <nav aria-label="Page navigation" class="mt-4">
        <ul class="pagination justify-content-center">
            {% if page_obj.has_previous %}
            <li class="page-item">
                <a class="page-link" href="?page={{ page_obj.previous_page_number }}{% if search %}&search={{ search }}{% endif %}{% if status_filter %}&status={{ status_filter }}{% endif %}">
                    이전
                </a>
            </li>
            {% endif %}
            
            {% for num in page_obj.paginator.page_range %}
            <li class="page-item {% if page_obj.number == num %}active{% endif %}">
                <a class="page-link" href="?page={{ num }}{% if search %}&search={{ search }}{% endif %}{% if status_filter %}&status={{ status_filter }}{% endif %}">
                    {{ num }}
                </a>
            </li>
            {% endfor %}
            
            {% if page_obj.has_next %}
            <li class="page-item">
                <a class="page-link" href="?page={{ page_obj.next_page_number }}{% if search %}&search={{ search }}{% endif %}{% if status_filter %}&status={{ status_filter }}{% endif %}">
                    다음
                </a>
            </li>
            {% endif %}
        </ul>
    </nav>
    {% endif %}

    {% else %}
    <div class="alert alert-light border text-center py-5">
        <i class="bi bi-inbox" style="font-size: 4rem; color: #dee2e6;"></i>
        <h4 class="mt-3">
            {% if search or status_filter %}
                검색 결과가 없습니다
            {% else %}
                비교 이력이 없습니다
            {% endif %}
        </h4>
        <p class="text-muted">
            {% if search or status_filter %}
                다른 검색 조건으로 시도해보세요.
            {% else %}
                이미지 상세 페이지에서 "비교" 버튼을 눌러 이미지를 비교해보세요.
            {% endif %}
        </p>
        {% if not search and not status_filter %}
        <a href="{% url 'content_list' %}" class="btn btn-primary btn-lg mt-3">
            <i class="bi bi-collection-play"></i> 콘텐츠 목록으로
        </a>
        {% endif %}
    </div>
    {% endif %}
</div>

<!-- 삭제 확인 폼 (숨김) -->
<form id="deleteForm" method="post" style="display: none;">
    {% csrf_token %}
    <input type="hidden" name="comparison_ids" id="comparisonIds">
</form>

<script>
// 전체 선택/해제
function toggleSelectAll(checkbox) {
    const checkboxes = document.querySelectorAll('.comparison-checkbox');
    checkboxes.forEach(cb => {
        cb.checked = checkbox.checked;
    });
    updateBulkActions();
}

// 선택 해제
function deselectAll() {
    document.getElementById('selectAll').checked = false;
    document.querySelectorAll('.comparison-checkbox').forEach(cb => {
        cb.checked = false;
    });
    updateBulkActions();
}

// 일괄 작업 툴바 업데이트
function updateBulkActions() {
    const checkboxes = document.querySelectorAll('.comparison-checkbox:checked');
    const count = checkboxes.length;
    const bulkActionBar = document.getElementById('bulkActionBar');
    const selectedCount = document.getElementById('selectedCount');
    
    if (count > 0) {
        bulkActionBar.style.display = 'block';
        selectedCount.textContent = count;
        
        // 카드 하이라이트
        document.querySelectorAll('.comparison-card').forEach(card => {
            const checkbox = card.querySelector('.comparison-checkbox');
            if (checkbox.checked) {
                card.classList.add('selected');
            } else {
                card.classList.remove('selected');
            }
        });
    } else {
        bulkActionBar.style.display = 'none';
        document.querySelectorAll('.comparison-card').forEach(card => {
            card.classList.remove('selected');
        });
    }
    
    // 전체 선택 체크박스 상태 업데이트
    const allCheckboxes = document.querySelectorAll('.comparison-checkbox');
    const selectAllCheckbox = document.getElementById('selectAll');
    selectAllCheckbox.checked = allCheckboxes.length > 0 && count === allCheckboxes.length;
}

// 일괄 삭제
function bulkDelete() {
    const checkboxes = document.querySelectorAll('.comparison-checkbox:checked');
    const count = checkboxes.length;
    
    if (count === 0) {
        alert('삭제할 항목을 선택해주세요.');
        return;
    }
    
    if (confirm(`선택한 ${count}개의 비교 결과를 삭제하시겠습니까?\n\n이 작업은 되돌릴 수 없습니다.`)) {
        const ids = Array.from(checkboxes).map(cb => cb.value);
        
        const form = document.getElementById('deleteForm');
        document.getElementById('comparisonIds').value = ids.join(',');
        form.action = '/image_compare/bulk-delete/';
        form.submit();
    }
}

// 개별 삭제
function deleteComparison(comparisonId, title) {
    if (confirm(`'${title}' 비교 결과를 삭제하시겠습니까?\n\n이 작업은 되돌릴 수 없습니다.`)) {
        const form = document.getElementById('deleteForm');
        document.getElementById('comparisonIds').value = comparisonId;
        form.action = `/image_compare/delete/${comparisonId}/`;
        form.submit();
    }
}

// 페이지 로드 시 초기화
document.addEventListener('DOMContentLoaded', function() {
    updateBulkActions();
});
</script>

<style>
.hover-card {
    transition: transform 0.2s ease, box-shadow 0.2s ease, border-color 0.2s ease;
}

.hover-card:hover {
    /* transform: translateY(-5px); */
    box-shadow: 0 10px 25px rgba(0,0,0,0.15) !important;
}

.comparison-card.selected {
    border: 3px solid #0d6efd !important;
    box-shadow: 0 8px 20px rgba(13, 110, 253, 0.3) !important;
}

/* 체크박스 스타일 - 세련된 디자인 */
.comparison-checkbox {
    width: 28px;
    height: 28px;
    cursor: pointer;
    border: 3px solid rgba(255, 255, 255, 0.95) !important;
    background-color: rgba(255, 255, 255, 0.4) !important;
    backdrop-filter: blur(8px);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.4) !important;
    transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
    border-radius: 6px !important;
}

.comparison-checkbox:hover {
    border-color: #0d6efd !important;
    background-color: rgba(13, 110, 253, 0.15) !important;
    /* transform: scale(1.15); */
    box-shadow: 0 6px 16px rgba(13, 110, 253, 0.4) !important;
}

.comparison-checkbox:checked {
    background-color: #0d6efd !important;
    border-color: #0d6efd !important;
    box-shadow: 0 6px 20px rgba(13, 110, 253, 0.6) !important;
}

/* 전체 선택 체크박스 */
#selectAll {
    width: 20px;
    height: 20px;
    cursor: pointer;
    transition: all 0.2s ease;
}

#selectAll:hover {
    transform: scale(1.1);
}

.btn-sm {
    font-size: 0.875rem;
    padding: 0.375rem 0.75rem;
}

.btn-outline-danger:hover {
    transform: scale(1.05);
}

.card-footer {
    padding: 0.75rem 1rem;
}

#bulkActionBar {
    animation: slideDown 0.3s ease;
}

@keyframes slideDown {
    from {
        opacity: 0;
        transform: translateY(-10px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}
</style>
{% endblock %}