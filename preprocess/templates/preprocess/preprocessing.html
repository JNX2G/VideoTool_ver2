{% extends 'contents/base.html' %}

{% block title %}전처리 설정 - {{ content.title }}{% endblock %}

{% block breadcrumb_items %}
    <!-- 1단계: 컨텐츠 상세 (완료) -->
    <li class="custom-breadcrumb-item">
        {% if content_type == 'image' %}
        <a href="{% url 'image_detail' content.id %}">
            <i class="bi bi-image"></i> 이미지 상세
        </a>
        {% else %}
        <a href="{% url 'video_detail' content.id %}">
            <i class="bi bi-camera-video"></i> 동영상 상세
        </a>
        {% endif %}
    </li>

    <!-- 2단계: 전처리 (현재 - 활성화) -->
    <li class="custom-breadcrumb-item active">
        <a href="{% url 'preprocess:start_preprocessing' content.id %}">
            <i class="bi bi-layers-half"></i> 전처리
        </a>
    </li>

    <!-- 3단계: 전처리 결과 (비활성화) -->
    <li class="custom-breadcrumb-item disabled">
        <span class="text-muted">
            <i class="bi bi-clipboard-data"></i> 전처리 결과
        </span>
    </li>

    <!-- 4단계: 모델 선택 (비활성화) -->
    <li class="custom-breadcrumb-item disabled">
        <span class="text-muted">
            <i class="bi bi-cpu-fill"></i> 모델 선택
        </span>
    </li>

    <!-- 5단계: 모델 실행 (비활성화) -->
    <li class="custom-breadcrumb-item disabled">
        <span class="text-muted">
            <i class="bi bi-play-circle-fill"></i> 모델 실행
        </span>
    </li>

    <!-- 6단계: 탐지 결과 (비활성화) -->
    <li class="custom-breadcrumb-item disabled">
        <span class="text-muted">
            <i class="bi bi-clipboard-data"></i> 탐지 결과
        </span>
    </li>
{% endblock %}

{% block content %}
<div class="row">
    <!-- 왼쪽: 미디어 뷰어 -->
    <div class="col-md-7">
        <div class="card mb-3 shadow-sm">
            <div class="card-header bg-white py-3">
                <h5 class="mb-0">
                    {% if content_type == 'image' %}
                        <i class="bi bi-image"></i> 원본 이미지
                    {% else %}
                        <i class="bi bi-camera-video"></i> 원본 동영상
                    {% endif %}
                </h5>
            </div>
            <div class="card-body">
                {% if content_type == 'image' %}
                    <!-- 이미지 -->
                    <div class="text-center">
                        <img src="{{ content.file.url }}" 
                             class="img-fluid rounded shadow-sm" 
                             alt="{{ content.title }}"
                             style="max-height: 500px;">
                    </div>
                {% else %}
                    <!-- 동영상 -->
                    <video width="100%" controls>
                        <source src="{% url 'serve_video' content.pk %}" type="video/mp4">
                    </video>
                {% endif %}
                
                <div class="mt-3">
                    <h5>{{ content.title }}</h5>
                    <p class="text-muted mb-0">
                        {% if content_type == 'image' %}
                            <i class="bi bi-aspect-ratio"></i> {{ content.get_resolution_display }}<br>
                        {% endif %}
                        <i class="bi bi-hdd"></i> {{ content.get_file_size_display }}<br>
                        <i class="bi bi-calendar"></i> {{ content.uploaded_at|date:"Y-m-d H:i" }}
                    </p>
                </div>
            </div>
        </div>
    </div>
    
    <!-- 오른쪽: 전처리 선택 -->
    <div class="col-md-5">
        <div class="card mb-3 shadow-sm">
            <div class="card-header bg-white py-3">
                <h5 class="mb-0">
                    <i class="bi bi-funnel"></i> 전처리 파이프라인 구성
                </h5>
            </div>
            <div class="card-body">
                <!-- 전처리 기법 선택 -->
                <div class="mb-3">
                    <label class="form-label fw-bold">전처리 기법 선택</label>
                    
                    {% if methods_by_category %}
                        <div class="accordion" id="methodsAccordion">
                            {% for category, methods in methods_by_category.items %}
                            <div class="accordion-item">
                                <h2 class="accordion-header" id="heading{{ forloop.counter }}">
                                    <button class="accordion-button {% if not forloop.first %}collapsed{% endif %}" 
                                            type="button" 
                                            data-bs-toggle="collapse" 
                                            data-bs-target="#collapse{{ forloop.counter }}"
                                            aria-expanded="{% if forloop.first %}true{% else %}false{% endif %}">
                                        <i class="bi bi-folder me-2"></i> {{ category }}
                                        <span class="badge bg-secondary ms-2">{{ methods|length }}</span>
                                    </button>
                                </h2>
                                <div id="collapse{{ forloop.counter }}" 
                                     class="accordion-collapse collapse {% if forloop.first %}show{% endif %}" 
                                     data-bs-parent="#methodsAccordion">
                                    <div class="accordion-body p-2">
                                        {% for method in methods %}
                                        <button type="button" 
                                                class="btn btn-outline-primary btn-sm w-100 mb-2 text-start"
                                                onclick="showMethodModal({{ method.id }}, '{{ method.name }}', {{ method.parameter_schema|safe }}, {{ method.default_parameters|safe }})">
                                            <i class="bi bi-plus-circle me-1"></i> {{ method.name }}
                                            {% if method.is_builtin %}
                                                <span class="badge bg-info float-end">내장</span>
                                            {% else %}
                                                <span class="badge bg-success float-end">커스텀</span>
                                            {% endif %}
                                        </button>
                                        {% endfor %}
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    {% else %}
                        <div class="alert alert-warning">
                            <i class="bi bi-exclamation-triangle"></i>
                            활성화된 전처리 기법이 없습니다. 
                            <a href="{% url 'prephub:method_list' %}" class="alert-link">전처리 기법 관리</a>에서 기법을 활성화하세요.
                        </div>
                    {% endif %}
                </div>

                <!-- 현재 파이프라인 -->
                <div class="mb-3">
                    <label class="form-label fw-bold">
                        현재 파이프라인
                        <span class="badge bg-secondary" id="pipelineCount">{{ current_pipeline|length }}</span>
                    </label>
                    
                    <div id="pipelineList" class="border rounded p-2" style="min-height: 100px;">
                        {% if current_pipeline %}
                            {% for step in current_pipeline %}
                            <div class="pipeline-step alert alert-light border mb-2 d-flex justify-content-between align-items-center">
                                <div>
                                    <strong>{{ forloop.counter }}.</strong> {{ step }}
                                </div>
                                <div class="btn-group btn-group-sm">
                                    {% if not forloop.first %}
                                    <button type="button" class="btn btn-outline-secondary" 
                                            onclick="moveStep({{ forloop.counter0 }}, 'up')" 
                                            title="위로">
                                        <i class="bi bi-arrow-up"></i>
                                    </button>
                                    {% endif %}
                                    {% if not forloop.last %}
                                    <button type="button" class="btn btn-outline-secondary" 
                                            onclick="moveStep({{ forloop.counter0 }}, 'down')" 
                                            title="아래로">
                                        <i class="bi bi-arrow-down"></i>
                                    </button>
                                    {% endif %}
                                    <button type="button" class="btn btn-outline-danger" 
                                            onclick="removeStep({{ forloop.counter0 }})" 
                                            title="제거">
                                        <i class="bi bi-x"></i>
                                    </button>
                                </div>
                            </div>
                            {% endfor %}
                        {% else %}
                            <div id="emptyPipelineMsg" class="text-center text-muted py-4">
                                <i class="bi bi-inbox" style="font-size: 2rem;"></i>
                                <p class="mb-0 mt-2">전처리 기법을 추가하세요</p>
                            </div>
                        {% endif %}
                    </div>
                    
                    {% if current_pipeline %}
                    <button type="button" class="btn btn-sm btn-outline-danger w-100 mt-2" onclick="clearPipeline()">
                        <i class="bi bi-trash"></i> 전체 초기화
                    </button>
                    {% endif %}
                </div>

                <!-- 실행 버튼 -->
                <div class="d-grid gap-2">
                    <button type="button" class="btn btn-primary btn-lg" onclick="executePipeline()">
                        <i class="bi bi-play-circle"></i> 전처리 실행
                    </button>
                    
                    <form method="post" style="display: inline;">
                        {% csrf_token %}
                        <input type="hidden" name="skip_preprocessing" value="true">
                        <button type="submit" class="btn btn-outline-secondary w-100">
                            <i class="bi bi-skip-forward"></i> 전처리 건너뛰기
                        </button>
                    </form>
                    
                    {% if content_type == 'video' %}
                        <a href="{% url 'video_detail' content.pk %}" class="btn btn-outline-secondary">
                            <i class="bi bi-arrow-left"></i> 돌아가기
                        </a>
                    {% else %}
                        <a href="{% url 'image_detail' content.pk %}" class="btn btn-outline-secondary">
                            <i class="bi bi-arrow-left"></i> 돌아가기
                        </a>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 파라미터 입력 모달 -->
<div class="modal fade" id="paramModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalTitle">전처리 기법 추가</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="paramForm">
                    <input type="hidden" id="methodId">
                    <div id="paramFields"></div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">취소</button>
                <button type="button" class="btn btn-primary" onclick="addStepToPipeline()">
                    <i class="bi bi-plus-circle"></i> 추가
                </button>
            </div>
        </div>
    </div>
</div>

<script>
const taskId = {{ task.id }};
const contentType = '{{ content_type }}';
let paramModal;

document.addEventListener('DOMContentLoaded', function() {
    paramModal = new bootstrap.Modal(document.getElementById('paramModal'));
});

function showMethodModal(methodId, methodName, paramSchema, defaultParams) {
    document.getElementById('modalTitle').textContent = methodName;
    document.getElementById('methodId').value = methodId;
    
    const paramFields = document.getElementById('paramFields');
    paramFields.innerHTML = '';
    
    if (Object.keys(paramSchema).length === 0) {
        paramFields.innerHTML = '<p class="text-muted">이 기법은 파라미터가 없습니다.</p>';
    } else {
        for (const [paramName, paramInfo] of Object.entries(paramSchema)) {
            const defaultValue = defaultParams[paramName] || paramInfo.default;
            
            let inputHtml = '';
            if (paramInfo.type === 'int') {
                inputHtml = `
                    <div class="mb-3">
                        <label class="form-label">${paramInfo.description || paramName}</label>
                        <input type="number" class="form-control" name="${paramName}" 
                               value="${defaultValue}" 
                               min="${paramInfo.min || ''}" 
                               max="${paramInfo.max || ''}" 
                               step="1">
                        <small class="text-muted">기본값: ${defaultValue}</small>
                    </div>
                `;
            } else if (paramInfo.type === 'float') {
                inputHtml = `
                    <div class="mb-3">
                        <label class="form-label">${paramInfo.description || paramName}</label>
                        <input type="number" class="form-control" name="${paramName}" 
                               value="${defaultValue}" 
                               min="${paramInfo.min || ''}" 
                               max="${paramInfo.max || ''}" 
                               step="0.1">
                        <small class="text-muted">기본값: ${defaultValue}</small>
                    </div>
                `;
            }
            
            paramFields.innerHTML += inputHtml;
        }
    }
    
    paramModal.show();
}

function addStepToPipeline() {
    const methodId = document.getElementById('methodId').value;
    const form = document.getElementById('paramForm');
    const formData = new FormData(form);
    
    const params = {};
    for (const [key, value] of formData.entries()) {
        params[key] = isNaN(value) ? value : Number(value);
    }
    
    fetch(`/preprocess/${taskId}/add-step/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': '{{ csrf_token }}'
        },
        body: JSON.stringify({
            method_id: methodId,
            params: params
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            updatePipelineDisplay(data.pipeline);
            paramModal.hide();
        } else {
            alert('오류: ' + (data.error || '알 수 없는 오류'));
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('전처리 단계 추가 실패');
    });
}

function removeStep(index) {
    if (!confirm('이 단계를 제거하시겠습니까?')) return;
    
    fetch(`/preprocess/${taskId}/remove-step/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': '{{ csrf_token }}'
        },
        body: JSON.stringify({ index: index })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            updatePipelineDisplay(data.pipeline);
        }
    });
}

function moveStep(fromIndex, direction) {
    const toIndex = direction === 'up' ? fromIndex - 1 : fromIndex + 1;
    
    fetch(`/preprocess/${taskId}/reorder-step/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': '{{ csrf_token }}'
        },
        body: JSON.stringify({
            from_index: fromIndex,
            to_index: toIndex
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            updatePipelineDisplay(data.pipeline);
        }
    });
}

function clearPipeline() {
    if (!confirm('전체 파이프라인을 초기화하시겠습니까?')) return;
    
    fetch(`/preprocess/${taskId}/clear-pipeline/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': '{{ csrf_token }}'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            updatePipelineDisplay(data.pipeline);
        }
    });
}

function updatePipelineDisplay(pipeline) {
    const pipelineList = document.getElementById('pipelineList');
    const pipelineCount = document.getElementById('pipelineCount');
    
    pipelineCount.textContent = pipeline.length;
    
    if (pipeline.length === 0) {
        pipelineList.innerHTML = `
            <div id="emptyPipelineMsg" class="text-center text-muted py-4">
                <i class="bi bi-inbox" style="font-size: 2rem;"></i>
                <p class="mb-0 mt-2">전처리 기법을 추가하세요</p>
            </div>
        `;
    } else {
        let html = '';
        pipeline.forEach((step, index) => {
            html += `
                <div class="pipeline-step alert alert-light border mb-2 d-flex justify-content-between align-items-center">
                    <div>
                        <strong>${index + 1}.</strong> ${step}
                    </div>
                    <div class="btn-group btn-group-sm">
                        ${index > 0 ? `
                            <button type="button" class="btn btn-outline-secondary" 
                                    onclick="moveStep(${index}, 'up')" title="위로">
                                <i class="bi bi-arrow-up"></i>
                            </button>
                        ` : ''}
                        ${index < pipeline.length - 1 ? `
                            <button type="button" class="btn btn-outline-secondary" 
                                    onclick="moveStep(${index}, 'down')" title="아래로">
                                <i class="bi bi-arrow-down"></i>
                            </button>
                        ` : ''}
                        <button type="button" class="btn btn-outline-danger" 
                                onclick="removeStep(${index})" title="제거">
                            <i class="bi bi-x"></i>
                        </button>
                    </div>
                </div>
            `;
        });
        pipelineList.innerHTML = html;
    }
    
    // 페이지 새로고침 (초기화 버튼 표시를 위해)
    location.reload();
}

function executePipeline() {
    if (confirm('전처리를 실행하시겠습니까?')) {
        fetch(`/preprocess/${taskId}/execute/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': '{{ csrf_token }}'
            }
        })
        .then(response => {
            if (response.redirected) {
                window.location.href = response.url;
            } else {
                window.location.href = `/preprocess/${taskId}/progress/`;
            }
        });
    }
}
</script>
{% endblock %}