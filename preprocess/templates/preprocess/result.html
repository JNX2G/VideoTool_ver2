{% extends 'contents/base.html' %}

{% block title %}전처리 결과 - {{ content.title }}{% endblock %}

{% block breadcrumb_items %}
    <li class="custom-breadcrumb-item">
        {% if content_type == 'image' %}
        <a href="{% url 'image_detail' content.id %}">
            <i class="bi bi-image"></i> 이미지 상세
        </a>
        {% else %}
        <a href="{% url 'video_detail' content.id %}">
            <i class="bi bi-camera-video"></i> 동영상 상세
        </a>
        {% endif %}
    </li>
    <li class="custom-breadcrumb-item">
        <a href="{% url 'preprocess:start_preprocessing' content.id %}">
            <i class="bi bi-layers-half"></i> 전처리
        </a>
    </li>
    <li class="custom-breadcrumb-item active">
        <a href="{% url 'preprocess:preprocessing_result' task.id %}">
            <i class="bi bi-clipboard-data"></i> 전처리 결과
        </a>
    </li>
    <li class="custom-breadcrumb-item disabled">
        <span class="text-muted"><i class="bi bi-cpu-fill"></i> 모델 선택</span>
    </li>
    <li class="custom-breadcrumb-item disabled">
        <span class="text-muted"><i class="bi bi-play-circle-fill"></i> 모델 실행</span>
    </li>
    <li class="custom-breadcrumb-item disabled">
        <span class="text-muted"><i class="bi bi-clipboard-data"></i> 모델 결과</span>
    </li>
{% endblock %}

{% block content %}
<div class="row row-cols-1 row-cols-md-2 g-4 mb-4">
    <div class="col">
        <div class="card h-100 border-0 shadow-sm">
            <div class="card-header bg-white py-3">
                <h6 class="mb-0 fw-bold">
                    <i class="bi bi-file-earmark"></i>
                    원본 {% if content_type == 'video' %}동영상{% else %}이미지{% endif %}
                </h6>
            </div>
            <div class="card-body d-flex flex-column">
                <!-- ⭐ 이미지 컨테이너 - 여백 제거 -->
                <div class="flex-grow-1 rounded overflow-hidden" style="min-height: 300px;">
                    {% if content_type == 'video' %}
                        <video id="originalVideo" width="100%" preload="metadata" style="display: block; width: 100%;">
                            <source src="{% url 'serve_video' content.pk %}" type="video/mp4">
                        </video>
                    {% else %}
                        <img src="{{ content.file.url }}" 
                             class="w-100" 
                             alt="원본 이미지"
                             style="display: block; height: auto; object-fit: contain;">
                    {% endif %}
                </div>
                
                {% if content_type == 'video' %}
                <div class="mt-3 px-1">
                    <div class="d-flex align-items-center gap-2">
                        <small class="text-secondary fw-bold" style="min-width: 30px;">원본</small>
                        <input type="range" id="originalSeekBar" class="form-range individual-range flex-grow-1" value="0" step="0.01">
                    </div>
                </div>
                {% endif %}

                <div class="mt-3">
                    <p class="text-muted mb-1 small">{{ content.title }}</p>
                    <small class="text-secondary">
                        <i class="bi bi-hdd"></i> {{ content.get_file_size_display }}
                    </small>
                </div>
            </div>
        </div>
    </div>

    <div class="col">
        <div class="card h-100 border-0 shadow-sm">
            <div class="card-header bg-white py-3 text-primary">
                <h6 class="mb-0 fw-bold">
                    <i class="bi bi-check-circle"></i> 전처리 결과
                </h6>
            </div>
            <div class="card-body d-flex flex-column">
                <!-- ⭐ 이미지 컨테이너 - 여백 제거 -->
                <div class="flex-grow-1 rounded overflow-hidden" style="min-height: 300px;">
                    {% if content_type == 'video' %}
                        <video id="processedVideo" width="100%" preload="metadata" style="display: block; width: 100%;">
                            <source src="{% url 'preprocess:serve_preprocessed_video' task.id %}" type="video/mp4">
                        </video>
                    {% else %}
                        <img src="{% url 'preprocess:serve_preprocessed_image' task.id %}" 
                             class="w-100" 
                             alt="전처리 결과"
                             style="display: block; height: auto; object-fit: contain;">
                    {% endif %}
                </div>

                {% if content_type == 'video' %}
                <div class="mt-3 px-1">
                    <div class="d-flex align-items-center gap-2">
                        <small class="text-primary fw-bold" style="min-width: 30px;">결과</small>
                        <input type="range" id="processedSeekBar" class="form-range individual-range flex-grow-1" value="0" step="0.01">
                    </div>
                </div>
                {% endif %}

                <div class="mt-3 d-flex justify-content-between align-items-center">
                    <div>
                        <p class="text-muted mb-1 small">
                            <i class="bi bi-check-circle text-success"></i> 전처리 완료
                        </p>
                        {% if content_type == 'video' %}
                            <small class="text-secondary"><i class="bi bi-film"></i> 프레임: {{ task.processed_frames }}</small>
                        {% endif %}
                    </div>
                    <a href="{% if content_type == 'video' %}{% url 'preprocess:serve_preprocessed_video' task.id %}{% else %}{% url 'preprocess:serve_preprocessed_image' task.id %}{% endif %}" 
                       download="processed_{{ content.file.name }}" class="btn btn-light btn-sm">
                        <i class="bi bi-download"></i> 다운로드
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>

{% if content_type == 'video' %}
<div class="row mb-4">
    <div class="col-md-12">
        <div class="card border-0 shadow-sm bg-light" style="border-radius: 10px;">
            <div class="card-body py-2 px-3">
                <div class="d-flex align-items-center gap-3">
                    <button id="masterPlayBtn" class="btn btn-sm d-flex align-items-center justify-content-center shadow-sm" 
                            style="width: 36px; height: 36px; border-radius: 50%; background-color: #fff; border: 1px solid #dee2e6; color: #495057;">
                        <i class="bi bi-play-fill"></i>
                    </button>
                    
                    <div class="flex-grow-1 position-relative d-flex align-items-center">
                        <input type="range" id="masterSeekBar" class="form-range custom-range" value="0" step="0.01">
                    </div>
                    
                    <div class="text-secondary small fw-light" style="font-variant-numeric: tabular-nums; min-width: 90px; text-align: center;">
                        <span id="currentTime">0:00</span> / <span id="totalTime">0:00</span>
                    </div>
                    
                    <button id="syncVideosBtn" class="btn btn-link btn-sm text-secondary p-0" title="싱크 강제 맞춤">
                        <i class="bi bi-arrow-repeat" style="font-size: 1.1rem;"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>
{% endif %}

<div class="row">
    <div class="col-md-12">
        <div class="card mb-3 border-0 shadow-sm">
            <div class="card-header bg-white py-3">
                <h6 class="mb-0 fw-bold"><i class="bi bi-funnel"></i> 적용된 전처리 파이프라인</h6>
            </div>
            <div class="card-body">
                {% if task.get_pipeline_display %}
                    <ol class="mb-3">
                        {% for step in task.get_pipeline_display %}
                            <li>{{ step }}</li>
                        {% endfor %}
                    </ol>
                {% else %}
                    <p class="text-muted mb-3"><i class="bi bi-info-circle"></i> 전처리를 적용하지 않았습니다</p>
                {% endif %}
                
                <div class="pt-3 border-top">
                    <div class="row">
                        <div class="col-md-4">
                            <p class="mb-1"><i class="bi bi-clock"></i> <strong>처리 시간:</strong> 
                                {% if task.started_at and task.completed_at %}{{ task.get_duration|floatformat:1 }}초{% else %}-{% endif %}</p>
                        </div>
                        <div class="col-md-4">
                            <p class="mb-1"><i class="bi bi-calendar"></i> <strong>완료 시각:</strong> {{ task.completed_at|date:"Y-m-d H:i:s" }}</p>
                        </div>
                        <div class="col-md-4">
                            <p class="mb-1">
                                {% if content_type == 'video' %}
                                    <i class="bi bi-film"></i> <strong>총 프레임:</strong> {{ task.total_frames }}
                                {% else %}
                                    <i class="bi bi-aspect-ratio"></i> <strong>해상도:</strong> {{ content.get_resolution_display }}
                                {% endif %}
                            </p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="card mb-4 border-0 shadow-sm">
    <div class="card-body">
        <div class="d-grid gap-2 d-md-flex justify-content-md-center">
            {% if task.status == 'completed' %}
            <a href="{% url 'vision_engine:select_model' task.id %}" class="btn btn-primary px-4" style="border-radius: 8px;">
                <i class="bi bi-cpu-fill"></i> 모델 적용하기
            </a>
            {% endif %}
            <a href="{% url 'preprocess:start_preprocessing' content.id %}?type={{ content_type }}" class="btn btn-warning px-4" style="border-radius: 8px;">
                <i class="bi bi-arrow-counterclockwise"></i> 다시 전처리하기
            </a>
            <a href="{% if content_type == 'video' %}{% url 'video_detail' content.id %}{% else %}{% url 'image_detail' content.id %}{% endif %}" 
               class="btn btn-outline-secondary px-4" style="border-radius: 8px;">
                <i class="bi bi-arrow-left"></i> 상세로 돌아가기
            </a>
        </div>
    </div>
</div>


<style>
/* 슬라이더 커스텀 스타일 */
.custom-range { height: 6px; padding: 0; }
.custom-range::-webkit-slider-runnable-track { background-color: #dee2e6; height: 6px; border-radius: 3px; }
.custom-range::-webkit-slider-thumb { 
    width: 16px; height: 16px; margin-top: -5px; 
    background-color: #0d6efd; border: 2px solid #fff; 
    border-radius: 50%; box-shadow: 0 1px 3px rgba(0,0,0,0.2); appearance: none;
}

/* 개별 슬라이더 스타일 */
.individual-range { height: 4px; padding: 0; }
.individual-range::-webkit-slider-runnable-track { background-color: #e9ecef; height: 4px; border-radius: 2px; }
.individual-range::-webkit-slider-thumb {
    width: 12px; height: 12px; margin-top: -4px;
    background-color: #adb5bd; border: 1px solid #fff;
    border-radius: 50%; appearance: none;
}

.card { transition: transform 0.2s; }
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const contentType = "{{ content_type }}";
    if (contentType !== 'video') return;

    const originalVideo = document.getElementById('originalVideo');
    const processedVideo = document.getElementById('processedVideo');
    
    const masterSeekBar = document.getElementById('masterSeekBar');
    const originalSeekBar = document.getElementById('originalSeekBar');
    const processedSeekBar = document.getElementById('processedSeekBar');
    
    const masterPlayBtn = document.getElementById('masterPlayBtn');
    const currentTimeText = document.getElementById('currentTime');
    const totalTimeText = document.getElementById('totalTime');
    const syncBtn = document.getElementById('syncVideosBtn');

    function formatTime(seconds) {
        const min = Math.floor(seconds / 60);
        const sec = Math.floor(seconds % 60);
        return `${min}:${sec < 10 ? '0' + sec : sec}`;
    }

    // 메타데이터 로드 시 전체 시간 설정
    processedVideo.addEventListener('loadedmetadata', () => {
        const duration = processedVideo.duration;
        masterSeekBar.max = duration;
        processedSeekBar.max = duration;
        totalTimeText.innerText = formatTime(duration);
    });

    originalVideo.addEventListener('loadedmetadata', () => {
        originalSeekBar.max = originalVideo.duration;
    });

    // 1. 마스터 플레이 버튼 (동시 재생/정지)
    masterPlayBtn.addEventListener('click', () => {
        if (processedVideo.paused) {
            originalVideo.play();
            processedVideo.play();
            masterPlayBtn.innerHTML = '<i class="bi bi-pause-fill"></i>';
        } else {
            originalVideo.pause();
            processedVideo.pause();
            masterPlayBtn.innerHTML = '<i class="bi bi-play-fill"></i>';
        }
    });

    // 2. 통합 슬라이더 (마스터) - 두 비디오 동시 이동
    masterSeekBar.addEventListener('input', () => {
        const targetTime = masterSeekBar.value;
        originalVideo.currentTime = targetTime;
        processedVideo.currentTime = targetTime;
    });

    // 3. 개별 슬라이더 - 원본만 이동개
    originalSeekBar.addEventListener('input', () => {
        originalVideo.currentTime = originalSeekBar.value;
    });

    // 4. 개별 슬라이더 - 결과만 이동
    processedSeekBar.addEventListener('input', () => {
        processedVideo.currentTime = processedSeekBar.value;
    });

    // 5. 비디오 상태 업데이트 (진행바 동기화)
    originalVideo.addEventListener('timeupdate', () => {
        originalSeekBar.value = originalVideo.currentTime;
    });

    processedVideo.addEventListener('timeupdate', () => {
        processedSeekBar.value = processedVideo.currentTime;
        masterSeekBar.value = processedVideo.currentTime;
        currentTimeText.innerText = formatTime(processedVideo.currentTime);
        
        // 재생 중일 때만 자동 싱크 유지 (0.5초 이상 벌어지면 보정)
        if (!processedVideo.paused) {
            if (Math.abs(originalVideo.currentTime - processedVideo.currentTime) > 0.5) {
                originalVideo.currentTime = processedVideo.currentTime;
            }
        }
    });

    // 6. 싱크 강제 맞춤 버튼 (원본을 결과에 맞춤)
    syncBtn.addEventListener('click', () => {
        originalVideo.currentTime = processedVideo.currentTime;
        if (!processedVideo.paused) originalVideo.play();
    });
});
</script>
{% endblock %}