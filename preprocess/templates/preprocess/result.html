{% extends 'contents/base.html' %}

{% block title %}전처리 결과 - {{ content.title }}{% endblock %}

{% block breadcrumb_items %}
    <li class="custom-breadcrumb-item">
        {% if content_type == 'image' %}
        <a href="{% url 'image_detail' content.id %}">
            <i class="bi bi-image"></i> 이미지 상세
        </a>
        {% else %}
        <a href="{% url 'video_detail' content.id %}">
            <i class="bi bi-camera-video"></i> 동영상 상세
        </a>
        {% endif %}
    </li>
    <li class="custom-breadcrumb-item">
        <a href="{% url 'preprocess:start_preprocessing' content.id %}">
            <i class="bi bi-layers-half"></i> 전처리
        </a>
    </li>
    <li class="custom-breadcrumb-item active">
        <a href="{% url 'preprocess:preprocessing_result' task.id %}">
            <i class="bi bi-clipboard-data"></i> 전처리 결과
        </a>
    </li>
    <li class="custom-breadcrumb-item disabled">
        <span class="text-muted"><i class="bi bi-cpu-fill"></i> 모델 선택</span>
    </li>
    <li class="custom-breadcrumb-item disabled">
        <span class="text-muted"><i class="bi bi-play-circle-fill"></i> 모델 실행</span>
    </li>
    <li class="custom-breadcrumb-item disabled">
        <span class="text-muted"><i class="bi bi-clipboard-data"></i> 탐지 결과</span>
    </li>
{% endblock %}

{% block content %}
<div class="row row-cols-1 row-cols-md-2 g-4 mb-4">
    <div class="col">
        <div class="card h-100 border-0 shadow-sm">
            <div class="card-header bg-white py-3">
                <h6 class="mb-0 fw-bold">
                    <i class="bi bi-file-earmark"></i>
                    원본 {% if content_type == 'video' %}동영상{% else %}이미지{% endif %}
                </h6>
            </div>
            <div class="card-body d-flex flex-column">
                <div class="flex-grow-1 d-flex align-items-center justify-content-center bg-black rounded overflow-hidden" style="min-height: 300px;">
                    {% if content_type == 'video' %}
                        <video id="originalVideo" width="100%" preload="metadata">
                            <source src="{% url 'serve_video' content.pk %}" type="video/mp4">
                        </video>
                    {% else %}
                        <img src="{{ content.file.url }}" class="img-fluid rounded" alt="원본 이미지">
                    {% endif %}
                </div>
                <div class="mt-3">
                    <p class="text-muted mb-1 small">{{ content.title }}</p>
                    <small class="text-secondary">
                        <i class="bi bi-hdd"></i> {{ content.get_file_size_display }}
                    </small>
                </div>
            </div>
        </div>
    </div>

    <div class="col">
        <div class="card h-100 border-0 shadow-sm">
            <div class="card-header bg-white py-3 text-primary">
                <h6 class="mb-0 fw-bold">
                    <i class="bi bi-check-circle"></i> 전처리 결과
                </h6>
            </div>
            <div class="card-body d-flex flex-column">
                <div class="flex-grow-1 d-flex align-items-center justify-content-center bg-black rounded overflow-hidden" style="min-height: 300px;">
                    {% if content_type == 'video' %}
                        <video id="processedVideo" width="100%" preload="metadata">
                            <source src="{% url 'preprocess:serve_preprocessed_video' task.id %}" type="video/mp4">
                        </video>
                    {% else %}
                        <img src="{% url 'preprocess:serve_preprocessed_image' task.id %}" class="img-fluid rounded shadow-sm" alt="전처리 결과">
                    {% endif %}
                </div>
                <div class="mt-3 d-flex justify-content-between align-items-center">
                    <div>
                        <p class="text-muted mb-1 small">
                            <i class="bi bi-check-circle text-success"></i> 전처리 완료
                        </p>
                        {% if content_type == 'video' %}
                            <small class="text-secondary"><i class="bi bi-film"></i> 프레임: {{ task.processed_frames }}</small>
                        {% endif %}
                    </div>
                    <a href="{% if content_type == 'video' %}{% url 'preprocess:serve_preprocessed_video' task.id %}{% else %}{% url 'preprocess:serve_preprocessed_image' task.id %}{% endif %}" 
                       download="processed_{{ content.file.name }}" class="btn btn-success btn-sm">
                        <i class="bi bi-download"></i> 다운로드
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>

{% if content_type == 'video' %}
<div class="row mb-4">
    <div class="col-md-12">
        <div class="card border-0 shadow-sm bg-light" style="border-radius: 10px;">
            <div class="card-body py-2 px-3">
                <div class="d-flex align-items-center gap-3">
                    <button id="masterPlayBtn" class="btn btn-sm d-flex align-items-center justify-content-center shadow-sm" 
                            style="width: 36px; height: 36px; border-radius: 50%; background-color: #fff; border: 1px solid #dee2e6; color: #495057;">
                        <i class="bi bi-play-fill"></i>
                    </button>
                    
                    <input type="range" id="masterSeekBar" class="form-range flex-grow-1 custom-range" value="0" step="0.01">
                    
                    <div class="text-secondary small fw-light" style="font-variant-numeric: tabular-nums; min-width: 90px; text-align: center;">
                        <span id="currentTime">0:00</span> / <span id="totalTime">0:00</span>
                    </div>
                    
                    <button id="syncVideosBtn" class="btn btn-link btn-sm text-secondary p-0" title="싱크 강제 맞춤">
                        <i class="bi bi-arrow-repeat" style="font-size: 1.1rem;"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>
{% endif %}

<div class="row">
    <div class="col-md-12">
        <div class="card mb-3 border-0 shadow-sm">
            <div class="card-header bg-white py-3">
                <h6 class="mb-0 fw-bold"><i class="bi bi-funnel"></i> 적용된 전처리 파이프라인</h6>
            </div>
            <div class="card-body">
                {% if task.get_pipeline_display %}
                    <ol class="mb-3">
                        {% for step in task.get_pipeline_display %}
                            <li>{{ step }}</li>
                        {% endfor %}
                    </ol>
                {% else %}
                    <p class="text-muted mb-3"><i class="bi bi-info-circle"></i> 전처리를 적용하지 않았습니다</p>
                {% endif %}
                
                <div class="pt-3 border-top">
                    <div class="row">
                        <div class="col-md-4">
                            <p class="mb-1"><i class="bi bi-clock"></i> <strong>처리 시간:</strong> 
                                {% if task.started_at and task.completed_at %}{{ task.get_duration|floatformat:1 }}초{% else %}-{% endif %}</p>
                        </div>
                        <div class="col-md-4">
                            <p class="mb-1"><i class="bi bi-calendar"></i> <strong>완료 시각:</strong> {{ task.completed_at|date:"Y-m-d H:i:s" }}</p>
                        </div>
                        <div class="col-md-4">
                            <p class="mb-1">
                                {% if content_type == 'video' %}
                                    <i class="bi bi-film"></i> <strong>총 프레임:</strong> {{ task.total_frames }}
                                {% else %}
                                    <i class="bi bi-aspect-ratio"></i> <strong>해상도:</strong> {{ content.get_resolution_display }}
                                {% endif %}
                            </p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="card mb-4 border-0 shadow-sm">
    <div class="card-body">
        <div class="d-grid gap-2 d-md-flex justify-content-md-center">
            {% if task.status == 'completed' %}
            <a href="#" class="btn btn-primary px-4" style="border-radius: 8px;">
                <i class="bi bi-cpu-fill"></i> 객체 탐지 시작
            </a>
            {% endif %}
            <a href="{% url 'preprocess:start_preprocessing' content.id %}?type={{ content_type }}" class="btn btn-warning px-4" style="border-radius: 8px;">
                <i class="bi bi-arrow-counterclockwise"></i> 다시 전처리하기
            </a>
            <a href="{% if content_type == 'video' %}{% url 'video_detail' content.id %}{% else %}{% url 'image_detail' content.id %}{% endif %}" 
               class="btn btn-outline-secondary px-4" style="border-radius: 8px;">
                <i class="bi bi-arrow-left"></i> 상세로 돌아가기
            </a>
        </div>
    </div>
</div>

<style>
/* 슬라이더 커스텀 스타일 */
.custom-range { height: 4px; padding: 0; }
.custom-range::-webkit-slider-runnable-track { background-color: #dee2e6; height: 4px; border-radius: 2px; }
.custom-range::-webkit-slider-thumb { 
    width: 14px; height: 14px; margin-top: -5px; 
    background-color: #0d6efd; border: 2px solid #fff; 
    border-radius: 50%; box-shadow: 0 1px 3px rgba(0,0,0,0.2); appearance: none;
}
.card { transition: transform 0.2s; }
/* .card:hover { transform: translateY(-2px); } */
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const contentType = "{{ content_type }}";
    if (contentType !== 'video') return;

    // 비디오 요소 및 컨트롤 요소 가져오기
    const originalVideo = document.getElementById('originalVideo');
    const processedVideo = document.getElementById('processedVideo');
    const masterSeekBar = document.getElementById('masterSeekBar');
    const masterPlayBtn = document.getElementById('masterPlayBtn');
    const currentTimeText = document.getElementById('currentTime');
    const totalTimeText = document.getElementById('totalTime');
    const syncBtn = document.getElementById('syncVideosBtn');

    function formatTime(seconds) {
        const min = Math.floor(seconds / 60);
        const sec = Math.floor(seconds % 60);
        return `${min}:${sec < 10 ? '0' + sec : sec}`;
    }

    // 1. 메타데이터 로드 시 전체 시간 및 슬라이더 설정
    processedVideo.addEventListener('loadedmetadata', () => {
        masterSeekBar.max = processedVideo.duration;
        totalTimeText.innerText = formatTime(processedVideo.duration);
    });

    // 2. 통합 재생/일시정지 제어
    masterPlayBtn.addEventListener('click', () => {
        if (processedVideo.paused) {
            originalVideo.play();
            processedVideo.play();
            masterPlayBtn.innerHTML = '<i class="bi bi-pause-fill"></i>';
        } else {
            originalVideo.pause();
            processedVideo.pause();
            masterPlayBtn.innerHTML = '<i class="bi bi-play-fill"></i>';
        }
    });

    // 3. 통합 플레이바 조작 (Seek)
    masterSeekBar.addEventListener('input', () => {
        originalVideo.currentTime = masterSeekBar.value;
        processedVideo.currentTime = masterSeekBar.value;
    });

    // 4. 재생 중 진행바 업데이트 및 자동 싱크 유지
    processedVideo.addEventListener('timeupdate', () => {
        masterSeekBar.value = processedVideo.currentTime;
        currentTimeText.innerText = formatTime(processedVideo.currentTime);
        
        // 두 영상의 시간 차이가 0.3초 이상 나면 강제 동기화
        if (Math.abs(originalVideo.currentTime - processedVideo.currentTime) > 0.3) {
            originalVideo.currentTime = processedVideo.currentTime;
        }
    });

    // 5. 싱크 강제 맞춤 버튼
    syncBtn.addEventListener('click', () => {
        originalVideo.currentTime = processedVideo.currentTime;
    });
});
</script>
{% endblock %}