{% extends 'contents/base.html' %}

{% block title %}ì „ì²˜ë¦¬ ê²°ê³¼ - {{ content.title }}{% endblock %}

{% block breadcrumb_items %}
    <!-- 1ë‹¨ê³„: ì»¨í…ì¸  ìƒì„¸ (ì™„ë£Œ) -->
    <li class="custom-breadcrumb-item">
        {% if content_type == 'image' %}
        <a href="{% url 'image_detail' content.id %}">
            <i class="bi bi-image"></i> ì´ë¯¸ì§€ ìƒì„¸
        </a>
        {% else %}
        <a href="{% url 'video_detail' content.id %}">
            <i class="bi bi-camera-video"></i> ë™ì˜ìƒ ìƒì„¸
        </a>
        {% endif %}
    </li>

    <!-- 2ë‹¨ê³„: ì „ì²˜ë¦¬ (ì™„ë£Œ) -->
    <li class="custom-breadcrumb-item">
        <a href="{% url 'preprocess:start_preprocessing' content.id %}">
            <i class="bi bi-layers-half"></i> ì „ì²˜ë¦¬
        </a>
    </li>

    <!-- 3ë‹¨ê³„: ì „ì²˜ë¦¬ ê²°ê³¼ (í˜„ì¬ - í™œì„±í™”) -->
    <li class="custom-breadcrumb-item active">
        <a href="{% url 'preprocess:preprocessing_result' task.id %}">
            <i class="bi bi-clipboard-data"></i> ì „ì²˜ë¦¬ ê²°ê³¼
        </a>
    </li>

    <!-- 4ë‹¨ê³„: ëª¨ë¸ ì„ íƒ (ë¹„í™œì„±í™”) -->
    <li class="custom-breadcrumb-item disabled">
        <span class="text-muted">
            <i class="bi bi-cpu-fill"></i> ëª¨ë¸ ì„ íƒ
        </span>
    </li>

    <!-- 5ë‹¨ê³„: ëª¨ë¸ ì‹¤í–‰ (ë¹„í™œì„±í™”) -->
    <li class="custom-breadcrumb-item disabled">
        <span class="text-muted">
            <i class="bi bi-play-circle-fill"></i> ëª¨ë¸ ì‹¤í–‰
        </span>
    </li>

    <!-- 6ë‹¨ê³„: íƒì§€ ê²°ê³¼ (ë¹„í™œì„±í™”) -->
    <li class="custom-breadcrumb-item disabled">
        <span class="text-muted">
            <i class="bi bi-clipboard-data"></i> íƒì§€ ê²°ê³¼
        </span>
    </li>
{% endblock %}

{% block content %}
<div class="row">
    <!-- ì™¼ìª½: ì›ë³¸ -->
    <div class="col-md-6">
        <div class="card mb-3 border-0 shadow-sm">
            <div class="card-header bg-white py-3">
                <h6 class="mb-0 fw-bold">
                    <i class="bi bi-file-earmark"></i>
                    ì›ë³¸ {% if content_type == 'video' %}ë™ì˜ìƒ{% else %}ì´ë¯¸ì§€{% endif %}
                </h6>
            </div>
            <div class="card-body">
                {% if content_type == 'video' %}
                    <video width="100%" controls preload="metadata" class="rounded">
                        <source src="{% url 'serve_video' content.pk %}" type="video/mp4">
                    </video>
                {% else %}
                    <img src="{{ content.file.url }}" class="img-fluid rounded" alt="ì›ë³¸ ì´ë¯¸ì§€">
                {% endif %}
                <div class="mt-2">
                    <p class="text-muted mb-1">{{ content.title }}</p>
                    <small class="text-secondary">
                        <i class="bi bi-hdd"></i> {{ content.get_file_size_display }}
                        {% if content_type == 'image' %}
                            | <i class="bi bi-aspect-ratio"></i> {{ content.get_resolution_display }}
                        {% endif %}
                    </small>
                </div>
            </div>
        </div>
    </div>

    <!-- ì˜¤ë¥¸ìª½: ì „ì²˜ë¦¬ ê²°ê³¼ -->
    <div class="col-md-6">
        <div class="card mb-3 border-0 shadow-sm">
            <div class="card-header bg-white py-3 text-primary">
                <h6 class="mb-0 fw-bold">
                    <i class="bi bi-check-circle"></i>
                    ì „ì²˜ë¦¬ ê²°ê³¼
                </h6>
            </div>
            <div class="card-body">
                {% if content_type == 'video' %}
                    <video id="processedVideo" width="100%" controls preload="metadata" class="rounded">
                        <source src="{% url 'preprocess:serve_preprocessed_video' task.id %}" type="video/mp4">
                        ë¸Œë¼ìš°ì €ê°€ ë™ì˜ìƒì„ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.
                    </video>
                {% else %}
                    <img src="{% url 'preprocess:serve_preprocessed_image' task.id %}" 
                         class="img-fluid rounded shadow-sm" 
                         alt="ì „ì²˜ë¦¬ëœ ì´ë¯¸ì§€">
                {% endif %}
                
                <div class="d-flex justify-content-between align-items-center mt-3">
                    <div>
                        <p class="text-muted mb-1">
                            <i class="bi bi-check-circle text-success"></i> ì „ì²˜ë¦¬ ì™„ë£Œ
                        </p>
                        {% if content_type == 'video' %}
                            <small class="text-secondary">
                                <i class="bi bi-film"></i> í”„ë ˆì„: {{ task.processed_frames }}
                            </small>
                        {% endif %}
                    </div>
                    <div>
                        <a href="{% if content_type == 'video' %}{% url 'preprocess:serve_preprocessed_video' task.id %}{% else %}{% url 'preprocess:serve_preprocessed_image' task.id %}{% endif %}" 
                           download="processed_{{ content.file.name }}" 
                           class="btn btn-success btn-sm">
                            <i class="bi bi-download"></i> ë‹¤ìš´ë¡œë“œ
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- ì „ì²˜ë¦¬ ì •ë³´ -->
<div class="row">
    <div class="col-md-12">
        <div class="card mb-3 border-0 shadow-sm">
            <div class="card-header bg-white py-3">
                <h6 class="mb-0 fw-bold">
                    <i class="bi bi-funnel"></i> ì ìš©ëœ ì „ì²˜ë¦¬ íŒŒì´í”„ë¼ì¸
                </h6>
            </div>
            <div class="card-body">
                {% if task.get_pipeline_display %}
                    <ol class="mb-3">
                        {% for step in task.get_pipeline_display %}
                            <li>{{ step }}</li>
                        {% endfor %}
                    </ol>
                {% else %}
                    <p class="text-muted mb-3">
                        <i class="bi bi-info-circle"></i> ì „ì²˜ë¦¬ë¥¼ ì ìš©í•˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤ (ì›ë³¸ ì‚¬ìš©)
                    </p>
                {% endif %}
                
                <div class="pt-3 border-top">
                    <div class="row">
                        <div class="col-md-4">
                            <p class="mb-1">
                                <i class="bi bi-clock"></i> <strong>ì²˜ë¦¬ ì‹œê°„:</strong>
                                {% if task.started_at and task.completed_at %}
                                    {{ task.get_duration|floatformat:1 }}ì´ˆ
                                {% else %}
                                    -
                                {% endif %}
                            </p>
                        </div>
                        <div class="col-md-4">
                            <p class="mb-1">
                                <i class="bi bi-calendar"></i> <strong>ì™„ë£Œ ì‹œê°:</strong>
                                {{ task.completed_at|date:"Y-m-d H:i:s" }}
                            </p>
                        </div>
                        <div class="col-md-4">
                            <p class="mb-1">
                                {% if content_type == 'video' %}
                                    <i class="bi bi-film"></i> <strong>ì´ í”„ë ˆì„:</strong> {{ task.total_frames }}
                                {% else %}
                                    <i class="bi bi-aspect-ratio"></i> <strong>í•´ìƒë„:</strong> {{ content.get_resolution_display }}
                                {% endif %}
                            </p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- ì‘ì—… ë²„íŠ¼ -->
<div class="card mb-4 border-0 shadow-sm">
    <div class="card-body">
        <div class="d-grid gap-2 d-md-flex justify-content-md-center">
            {% if task.status == 'completed' %}
            <a href="{#{% url 'vision_engine:select_model' task.id %}#}" 
               class="btn btn-primary px-4" 
               style="border-radius: 8px;">
                <i class="bi bi-cpu-fill"></i> ê°ì²´ íƒì§€ ì‹œì‘
            </a>
            {% else %}
            <button class="btn btn-secondary px-4" 
                    disabled 
                    title="ì „ì²˜ë¦¬ê°€ ì™„ë£Œë˜ì–´ì•¼ í•©ë‹ˆë‹¤" 
                    style="border-radius: 8px;">
                <i class="bi bi-cpu-fill"></i> ê°ì²´ íƒì§€ ì‹œì‘
            </button>
            {% endif %}
            
            <a href="{% url 'preprocess:start_preprocessing' content.id %}?type={{ content_type }}" 
               class="btn btn-warning px-4" 
               style="border-radius: 8px;">
                <i class="bi bi-arrow-counterclockwise"></i> ë‹¤ì‹œ ì „ì²˜ë¦¬í•˜ê¸°
            </a>
            
            <a href="{% if content_type == 'video' %}{% url 'video_detail' content.id %}{% else %}{% url 'image_detail' content.id %}{% endif %}" 
               class="btn btn-outline-secondary px-4" 
               style="border-radius: 8px;">
                <i class="bi bi-arrow-left"></i> ìƒì„¸ë¡œ ëŒì•„ê°€ê¸°
            </a>
        </div>
    </div>
</div>

<script>
const contentType = "{{ content_type }}";

if (contentType === 'video') {
    const processedVideo = document.getElementById('processedVideo');

    if (processedVideo) {
        console.log('ğŸ¬ ë™ì˜ìƒ ìš”ì†Œ:', processedVideo);
        console.log('ğŸ¬ ì†ŒìŠ¤ URL:', processedVideo.querySelector('source')?.src);
        
        // ê°•ì œë¡œ ë¡œë“œ ì‹œë„
        processedVideo.load();
        
        processedVideo.addEventListener('loadstart', function() {
            console.log('ğŸ”¥ loadstart');
        });
        
        processedVideo.addEventListener('loadedmetadata', function() {
            console.log('âœ… loadedmetadata');
            console.log('Duration:', processedVideo.duration);
            console.log('ReadyState:', processedVideo.readyState);
        });
        
        processedVideo.addEventListener('loadeddata', function() {
            console.log('âœ… loadeddata');
        });
        
        processedVideo.addEventListener('canplay', function() {
            console.log('âœ… canplay - ì¬ìƒ ê°€ëŠ¥!');
        });
        
        processedVideo.addEventListener('canplaythrough', function() {
            console.log('âœ… canplaythrough - ì „ì²´ ì¬ìƒ ê°€ëŠ¥!');
        });
        
        processedVideo.addEventListener('progress', function() {
            if (processedVideo.buffered.length > 0) {
                const bufferedEnd = processedVideo.buffered.end(0);
                const duration = processedVideo.duration;
                const percent = (bufferedEnd / duration * 100).toFixed(2);
                console.log(`ğŸ“Š ë²„í¼ë§: ${percent}% (${bufferedEnd.toFixed(2)}s / ${duration.toFixed(2)}s)`);
            }
        });
        
        processedVideo.addEventListener('waiting', function() {
            console.log('â³ waiting - ë²„í¼ë§ ì¤‘');
        });
        
        processedVideo.addEventListener('stalled', function() {
            console.warn('âš ï¸ stalled - ë¡œë”© ë©ˆì¶¤');
        });
        
        processedVideo.addEventListener('suspend', function() {
            console.log('â¸ï¸ suspend - ë¡œë”© ì¼ì‹œì¤‘ë‹¨');
        });
        
        processedVideo.addEventListener('error', function(e) {
            console.error('âŒ ì—ëŸ¬!');
            console.error('Error code:', processedVideo.error?.code);
            console.error('Error message:', processedVideo.error?.message);
            console.error('Network state:', processedVideo.networkState);
            console.error('Ready state:', processedVideo.readyState);
            
            alert('ë™ì˜ìƒ ë¡œë“œ ì‹¤íŒ¨! ì½˜ì†”ì„ í™•ì¸í•˜ì„¸ìš”.');
        });
    }
}
</script>

<style>
.card {
    transition: transform 0.2s;
}

.card:hover {
    transform: translateY(-2px);
}
</style>
{% endblock %}