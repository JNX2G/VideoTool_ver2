{% extends 'contents/base.html' %}

{% block title %}ì „ì²˜ë¦¬ ì§„í–‰ ì¤‘{% endblock %}

{% block breadcrumb_items %}
    <!-- 1ë‹¨ê³„: ì»¨í…ì¸  ìƒì„¸ (ì™„ë£Œ) -->
    <li class="custom-breadcrumb-item">
        {% if content_type == 'image' %}
        <a href="{% url 'image_detail' content.id %}">
            <i class="bi bi-image"></i> ì´ë¯¸ì§€ ìƒì„¸
        </a>
        {% else %}
        <a href="{% url 'video_detail' content.id %}">
            <i class="bi bi-camera-video"></i> ë™ì˜ìƒ ìƒì„¸
        </a>
        {% endif %}
    </li>

    <!-- 2ë‹¨ê³„: ì „ì²˜ë¦¬ (ì™„ë£Œ) -->
    <li class="custom-breadcrumb-item">
        <a href="{% url 'preprocess:start_preprocessing' content.id %}">
            <i class="bi bi-layers-half"></i> ì „ì²˜ë¦¬
        </a>
    </li>

    <!-- 3ë‹¨ê³„: ì „ì²˜ë¦¬ ì§„í–‰ ì¤‘ (í˜„ì¬ - í™œì„±í™”) -->
    <li class="custom-breadcrumb-item active">
        <a href="#">
            <i class="bi bi-hourglass-split"></i> ì „ì²˜ë¦¬ ì¤‘
        </a>
    </li>

    <!-- 4ë‹¨ê³„: ì „ì²˜ë¦¬ ê²°ê³¼ (ë¹„í™œì„±í™”) -->
    <li class="custom-breadcrumb-item disabled">
        <span class="text-muted">
            <i class="bi bi-clipboard-data"></i> ì „ì²˜ë¦¬ ê²°ê³¼
        </span>
    </li>

    <!-- 5ë‹¨ê³„: ëª¨ë¸ ì„ íƒ (ë¹„í™œì„±í™”) -->
    <li class="custom-breadcrumb-item disabled">
        <span class="text-muted">
            <i class="bi bi-cpu-fill"></i> ëª¨ë¸ ì„ íƒ
        </span>
    </li>

    <!-- 6ë‹¨ê³„: ëª¨ë¸ ì‹¤í–‰ (ë¹„í™œì„±í™”) -->
    <li class="custom-breadcrumb-item disabled">
        <span class="text-muted">
            <i class="bi bi-play-circle-fill"></i> ëª¨ë¸ ì‹¤í–‰
        </span>
    </li>

    <!-- 7ë‹¨ê³„: íƒì§€ ê²°ê³¼ (ë¹„í™œì„±í™”) -->
    <li class="custom-breadcrumb-item disabled">
        <span class="text-muted">
            <i class="bi bi-clipboard-data"></i> ëª¨ë¸ ê²°ê³¼
        </span>
    </li>
{% endblock %}

{% block content %}
<div class="container" style="max-width: 800px;">
    <div class="card shadow-sm">
        <div class="card-body p-4">
            <!-- ì»¨í…ì¸  ì •ë³´ -->
            <div class="text-center mb-4">
                <h5>
                    {% if content_type == 'video' %}
                        <i class="bi bi-camera-video text-primary"></i>
                    {% else %}
                        <i class="bi bi-image text-success"></i>
                    {% endif %}
                    {{ content.title }}
                </h5>
            </div>

            <!-- ì§„í–‰ë¥  ë°” -->
            <div class="mb-4">
                <div class="d-flex justify-content-between mb-2">
                    <span><strong>ì§„í–‰ë¥ </strong></span>
                    <span id="progressText">{{ task.progress }}%</span>
                </div>
                <div class="progress" style="height: 30px;">
                    <div id="progressBar" 
                         class="progress-bar progress-bar-striped progress-bar-animated" 
                         role="progressbar" 
                         style="width: {{ task.progress }}%"
                         aria-valuenow="{{ task.progress }}" 
                         aria-valuemin="0" 
                         aria-valuemax="100">
                        <span id="progressPercent">{{ task.progress }}%</span>
                    </div>
                </div>
            </div>

            <!-- ìƒíƒœ ì •ë³´ -->
            <div class="card bg-light mb-3">
                <div class="card-body">
                    <div class="row text-center">
                        <div class="col-md-4">
                            <h6 class="text-muted">ìƒíƒœ</h6>
                            <span class="badge bg-{{ task.get_status_display_badge }}" id="statusBadge">
                                {{ task.get_status_display }}
                            </span>
                        </div>
                        {% if content_type == 'video' %}
                        <div class="col-md-4">
                            <h6 class="text-muted">ì²˜ë¦¬ í”„ë ˆì„</h6>
                            <p class="mb-0">
                                <span id="processedFrames">{{ task.processed_frames }}</span> / 
                                <span id="totalFrames">{{ task.total_frames }}</span>
                            </p>
                        </div>
                        {% endif %}
                        <div class="col-md-4">
                            <h6 class="text-muted">ì „ì²˜ë¦¬ ë‹¨ê³„</h6>
                            <p class="mb-0">{{ task.preprocessing_pipeline|length }}ê°œ</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ì „ì²˜ë¦¬ íŒŒì´í”„ë¼ì¸ -->
            <div class="mb-3">
                <h6><i class="bi bi-list-ol"></i> ì „ì²˜ë¦¬ íŒŒì´í”„ë¼ì¸</h6>
                <div>
                    {% if task.get_pipeline_display %}
                        {% for step in task.get_pipeline_display %}
                            <span class="badge bg-secondary me-1 mb-1">{{ forloop.counter }}. {{ step }}</span>
                        {% endfor %}
                    {% else %}
                        <span class="text-muted">ì „ì²˜ë¦¬ ì—†ìŒ (ì›ë³¸ ì‚¬ìš©)</span>
                    {% endif %}
                </div>
            </div>

            <!-- í˜„ì¬ ë‹¨ê³„ í‘œì‹œ -->
            {% if task.current_step %}
            <div class="alert alert-info mb-3">
                <i class="bi bi-arrow-right-circle"></i> <strong>í˜„ì¬:</strong> {{ task.current_step }}
            </div>
            {% endif %}

            <!-- ì—ëŸ¬ ë©”ì‹œì§€ -->
            <div id="errorContainer" style="display: {% if task.status == 'failed' %}block{% else %}none{% endif %};">
                <div class="alert alert-danger">
                    <h6><i class="bi bi-exclamation-triangle"></i> ì˜¤ë¥˜ ë°œìƒ</h6>
                    <p id="errorMessage" class="mb-0">{{ task.error_message|default:"ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤." }}</p>
                </div>
            </div>

            <!-- ë²„íŠ¼ ì»¨í…Œì´ë„ˆ -->
            <div class="d-grid gap-2 mt-4" id="buttonContainer">
                <!-- ì´ˆê¸° ìƒíƒœë³„ ë²„íŠ¼ -->
                {% if task.status == 'completed' %}
                    <button class="btn btn-success btn-lg" onclick="goToResult()">
                        <i class="bi bi-check-circle"></i> ê²°ê³¼ ë³´ê¸°
                    </button>
                
                {% elif task.status == 'failed' %}
                    <!-- ìˆ˜ì •: ì‹¤íŒ¨ ì‹œ ì¬ì‹œì‘ ë²„íŠ¼ -->
                    <form method="post" action="{% url 'preprocess:restart_task' task.id %}">
                        {% csrf_token %}
                        <button type="submit" class="btn btn-warning btn-lg w-100">
                            <i class="bi bi-arrow-clockwise"></i> ì¬ì‹œì‘
                        </button>
                    </form>
                
                {% else %}
                    <!-- ìˆ˜ì •: pending ë˜ëŠ” processing ìƒíƒœì—ì„œ ì·¨ì†Œ/ì¬ì‹œì‘ ë²„íŠ¼ í‘œì‹œ -->
                    {% if task.status == 'pending' %}
                        <!-- pending ìƒíƒœ: ì¬ì‹œì‘ + ì·¨ì†Œ -->
                        <form method="post" action="{% url 'preprocess:restart_task' task.id %}">
                            {% csrf_token %}
                            <button type="submit" class="btn btn-warning btn-lg w-100">
                                <i class="bi bi-arrow-clockwise"></i> ì¬ì‹œì‘
                            </button>
                        </form>
                        <button type="button" class="btn btn-danger btn-lg" onclick="confirmCancel()">
                            <i class="bi bi-x-circle"></i> ì‘ì—… ì·¨ì†Œ
                        </button>
                    {% else %}
                        <!-- processing ìƒíƒœ: ì·¨ì†Œë§Œ -->
                        <button type="button" class="btn btn-danger btn-lg" onclick="confirmCancel()">
                            <i class="bi bi-x-circle"></i> ì‘ì—… ì·¨ì†Œ
                        </button>
                    {% endif %}
                {% endif %}
                
                <!-- ëŒì•„ê°€ê¸° ë²„íŠ¼ -->
                {% if content_type == 'video' %}
                    <a href="{% url 'preprocess:start_preprocessing' content.pk %}?type=video" class="btn btn-outline-secondary">
                        <i class="bi bi-arrow-left"></i> íŒŒì´í”„ë¼ì¸ í¸ì§‘ìœ¼ë¡œ ëŒì•„ê°€ê¸°
                    </a>
                {% else %}
                    <a href="{% url 'preprocess:start_preprocessing' content.pk %}?type=image" class="btn btn-outline-secondary">
                        <i class="bi bi-arrow-left"></i> íŒŒì´í”„ë¼ì¸ í¸ì§‘ìœ¼ë¡œ ëŒì•„ê°€ê¸°
                    </a>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<script>
const taskId = {{ task.id }};
const contentType = '{{ content_type }}';
const contentId = {{ content.id }};
const csrfToken = '{{ csrf_token }}';

let pollInterval;
let isCompleted = false;

// ê²°ê³¼ í˜ì´ì§€ë¡œ ì´ë™
function goToResult() {
    window.location.href = `/preprocess/${taskId}/result/`;
}

// ìƒíƒœì— ë”°ë¥¸ ë²„íŠ¼ ì—…ë°ì´íŠ¸
function updateButtonForStatus(status) {
    const buttonContainer = document.getElementById('buttonContainer');
    
    // ëŒì•„ê°€ê¸° ë²„íŠ¼ HTML ë³´ì¡´
    const backBtn = buttonContainer.querySelector('.btn-outline-secondary');
    const backBtnHTML = backBtn ? backBtn.outerHTML : '';
    
    let actionBtnHTML = '';

    if (status === 'completed') {
        // ì²˜ë¦¬ ì™„ë£Œ
        actionBtnHTML = `
            <button class="btn btn-success btn-lg" onclick="goToResult()">
                <i class="bi bi-check-circle"></i> ê²°ê³¼ ë³´ê¸°
            </button>
        `;
    } else if (status === 'failed') {
        // ì‹¤íŒ¨ -> ì „ì²˜ë¦¬ ê³¼ì •ì—ì„œ ì˜¤ë¥˜ê°€ ë‚¨
        actionBtnHTML = `
            <form method="post" action="/preprocess/${taskId}/restart/">
                <input type="hidden" name="csrfmiddlewaretoken" value="${csrfToken}">
                <button type="submit" class="btn btn-warning btn-lg w-100">
                    <i class="bi bi-arrow-clockwise"></i> ì¬ì‹œì‘
                </button>
            </form>
        `;
    } else if (status === 'pending') {
        // ëŒ€ê¸° ì¤‘ 
        actionBtnHTML = `
            <form method="post" action="/preprocess/${taskId}/restart/">
                <input type="hidden" name="csrfmiddlewaretoken" value="${csrfToken}">
                <button type="submit" class="btn btn-warning btn-lg w-100">
                    <i class="bi bi-arrow-clockwise"></i> ì¬ì‹œì‘
                </button>
            </form>
            <button type="button" class="btn btn-danger btn-lg" onclick="confirmCancel()">
                <i class="bi bi-x-circle"></i> ì‘ì—… ì·¨ì†Œ
            </button>
        `;
    } else if (status === 'processing') {
        // ì²˜ë¦¬ ì¤‘
        actionBtnHTML = `
            <button type="button" class="btn btn-danger btn-lg" onclick="confirmCancel()">
                <i class="bi bi-x-circle"></i> ì‘ì—… ì·¨ì†Œ
            </button>
        `;
    } else if (status === 'cancelled') {
        // ì·¨
        actionBtnHTML = `
            <div class="alert alert-secondary mb-0">
                <i class="bi bi-x-circle"></i> ì‘ì—…ì´ ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤.
            </div>
        `;
    }
    
    buttonContainer.innerHTML = actionBtnHTML + backBtnHTML;
}

// ì§„í–‰ ìƒí™© ì—…ë°ì´íŠ¸ (í´ë§)
function updateProgress() {
    fetch(`/preprocess/${taskId}/status/`)
        .then(response => response.json())
        .then(data => {
            console.log('ğŸ“Š Progress update:', data);
            
            // ì§„í–‰ë¥  ì—…ë°ì´íŠ¸
            const progressBar = document.getElementById('progressBar');
            const progressPercent = document.getElementById('progressPercent');
            const progressText = document.getElementById('progressText');
            
            if (progressBar) {
                progressBar.style.width = data.progress + '%';
                progressBar.setAttribute('aria-valuenow', data.progress);
            }
            if (progressPercent) {
                progressPercent.textContent = data.progress + '%';
            }
            if (progressText) {
                progressText.textContent = data.progress + '%';
            }
            
            // ìƒíƒœ ë°°ì§€ ì—…ë°ì´íŠ¸
            const statusBadge = document.getElementById('statusBadge');
            if (statusBadge && data.status_display && data.status_badge) {
                statusBadge.textContent = data.status_display;
                statusBadge.className = 'badge bg-' + data.status_badge;
            }
            
            {% if content_type == 'video' %}
            // í”„ë ˆì„ ì •ë³´ ì—…ë°ì´íŠ¸
            const processedFrames = document.getElementById('processedFrames');
            const totalFrames = document.getElementById('totalFrames');
            
            if (processedFrames && data.processed_frames !== undefined) {
                processedFrames.textContent = data.processed_frames;
            }
            if (totalFrames && data.total_frames !== undefined) {
                totalFrames.textContent = data.total_frames;
            }
            {% endif %}
            
            // â­ ì™„ë£Œ ì²˜ë¦¬
            if (data.status === 'completed' && !isCompleted) {
                console.log('âœ… ì‘ì—… ì™„ë£Œ!');
                isCompleted = true;
                clearInterval(pollInterval);
                
                // ì§„í–‰ë¥  ë°” ì• ë‹ˆë©”ì´ì…˜ ì œê±°
                if (progressBar) {
                    progressBar.classList.remove('progress-bar-animated');
                    progressBar.classList.remove('progress-bar-striped');
                    progressBar.classList.add('bg-success');
                }
                
                // ë²„íŠ¼ ì—…ë°ì´íŠ¸
                updateButtonForStatus('completed');
                
                // ğŸ‰ ì™„ë£Œ ì•Œë¦¼ í‘œì‹œ (ìë™ ì´ë™ ì œê±°)
                const alertHtml = `
                    <div class="alert alert-success alert-dismissible fade show mt-3" role="alert">
                        <h5 class="alert-heading">
                            <i class="bi bi-check-circle-fill"></i> ì „ì²˜ë¦¬ ì™„ë£Œ!
                        </h5>
                        <p class="mb-0">ê²°ê³¼ë¥¼ í™•ì¸í•˜ë ¤ë©´ ì•„ë˜ ë²„íŠ¼ì„ í´ë¦­í•˜ì„¸ìš”.</p>
                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                    </div>
                `;
                
                // ì—ëŸ¬ ì»¨í…Œì´ë„ˆ ì•ì— ì•Œë¦¼ ì‚½ì…
                const errorContainer = document.getElementById('errorContainer');
                if (errorContainer) {
                    errorContainer.insertAdjacentHTML('beforebegin', alertHtml);
                }
            }
            
            // ì‹¤íŒ¨ ì²˜ë¦¬
            else if (data.status === 'failed') {
                console.log('âŒ ì‘ì—… ì‹¤íŒ¨');
                clearInterval(pollInterval);
                
                // ì§„í–‰ë¥  ë°” ìŠ¤íƒ€ì¼ ë³€ê²½
                if (progressBar) {
                    progressBar.classList.remove('progress-bar-animated');
                    progressBar.classList.remove('progress-bar-striped');
                    progressBar.classList.add('bg-danger');
                }
                
                // ì—ëŸ¬ ë©”ì‹œì§€ í‘œì‹œ
                const errorContainer = document.getElementById('errorContainer');
                const errorMessage = document.getElementById('errorMessage');
                if (errorContainer && errorMessage) {
                    errorMessage.textContent = data.error_message || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.';
                    errorContainer.style.display = 'block';
                }
                
                // ë²„íŠ¼ ì—…ë°ì´íŠ¸
                updateButtonForStatus('failed');
            }
            
            // ì·¨ì†Œë¨ ì²˜ë¦¬
            else if (data.status === 'cancelled') {
                console.log('ğŸ›‘ ì‘ì—… ì·¨ì†Œë¨');
                clearInterval(pollInterval);
                
                if (progressBar) {
                    progressBar.classList.remove('progress-bar-animated');
                    progressBar.classList.add('bg-secondary');
                }
                
                // ë²„íŠ¼ ì—…ë°ì´íŠ¸
                updateButtonForStatus('cancelled');
            }
            
            // pending ìƒíƒœì—ì„œ processingìœ¼ë¡œ ë³€ê²½ë˜ë©´ ë²„íŠ¼ ì—…ë°ì´íŠ¸
            else if (data.status === 'processing') {
                // ë²„íŠ¼ì´ ë³€ê²½ë˜ì–´ì•¼ í•˜ëŠ” ê²½ìš° ì—…ë°ì´íŠ¸
                const currentRestartBtn = buttonContainer.querySelector('form button');
                if (currentRestartBtn && currentRestartBtn.textContent.includes('ì¬ì‹œì‘')) {
                    updateButtonForStatus('processing');
                }
            }
        })
        .catch(error => {
            console.error('â— ì§„í–‰ ìƒí™© ì—…ë°ì´íŠ¸ ì‹¤íŒ¨:', error);
            // ì—ëŸ¬ ë°œìƒ ì‹œ í´ë§ ê³„ì† (ë„¤íŠ¸ì›Œí¬ ì¼ì‹œì  ì˜¤ë¥˜ ê°€ëŠ¥)
        });
}

// ì‘ì—… ì·¨ì†Œ í™•ì¸ ë° ì‹¤í–‰
function confirmCancel() {
    if (!confirm('ì •ë§ë¡œ ì‘ì—…ì„ ì·¨ì†Œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\nì·¨ì†Œ í›„ íŒŒì´í”„ë¼ì¸ì„ í¸ì§‘í•˜ì‹¤ ìˆ˜ ìˆìŠµë‹ˆë‹¤.')) {
        return;
    }
    
    console.log('ğŸ›‘ ì‘ì—… ì·¨ì†Œ ìš”ì²­ ì¤‘...');
    
    // ë²„íŠ¼ ë¹„í™œì„±í™”
    const cancelBtn = event.target;
    cancelBtn.disabled = true;
    cancelBtn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> ì·¨ì†Œ ì¤‘...';
    
    // í´ë§ ì¤‘ì§€
    if (pollInterval) {
        clearInterval(pollInterval);
    }
    
    fetch(`/preprocess/${taskId}/cancel/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrfToken,
            'X-Requested-With': 'XMLHttpRequest'
        }
    })
    .then(response => {
        console.log('ğŸ“¡ Cancel response status:', response.status);
        
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        
        return response.json();
    })
    .then(data => {
        console.log('âœ… Cancel response:', data);
        
        if (data.success) {
            console.log('ğŸš€ íŒŒì´í”„ë¼ì¸ í¸ì§‘ í˜ì´ì§€ë¡œ ë¦¬ë‹¤ì´ë ‰íŠ¸...');
            
            // â­ preprocessing.htmlë¡œ ì¦‰ì‹œ ì´ë™
            if (data.redirect_url) {
                window.location.href = data.redirect_url;
            } else {
                // fallback
                if (contentType === 'video') {
                    window.location.href = `/preprocess/start/${contentId}/?type=video`;
                } else {
                    window.location.href = `/preprocess/start/${contentId}/?type=image`;
                }
            }
        } else {
            alert(data.message || 'ì‘ì—… ì·¨ì†Œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
            cancelBtn.disabled = false;
            cancelBtn.innerHTML = '<i class="bi bi-x-circle"></i> ì‘ì—… ì·¨ì†Œ';
            
            // í´ë§ ì¬ì‹œì‘
            pollInterval = setInterval(updateProgress, 1000);
        }
    })
    .catch(error => {
        console.error('â— ì‘ì—… ì·¨ì†Œ ì‹¤íŒ¨:', error);
        alert('ì‘ì—… ì·¨ì†Œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.\n' + error.message);
        
        // ë²„íŠ¼ ë³µêµ¬
        cancelBtn.disabled = false;
        cancelBtn.innerHTML = '<i class="bi bi-x-circle"></i> ì‘ì—… ì·¨ì†Œ';
        
        // í´ë§ ì¬ì‹œì‘
        if (!pollInterval) {
            pollInterval = setInterval(updateProgress, 1000);
        }
    });
}

// ì´ˆê¸°í™” ë° í´ë§ ì‹œì‘
document.addEventListener('DOMContentLoaded', function() {
    console.log('ğŸ“Œ Progress page loaded - Task ID:', taskId);
    
    // ì´ˆê¸° ìƒíƒœê°€ ì´ë¯¸ ì™„ë£Œì¸ì§€ í™•ì¸
    const initialStatus = '{{ task.status }}';
    console.log('ğŸ“Œ Initial status:', initialStatus);
    
    if (initialStatus === 'completed') {
        isCompleted = true;
        console.log('âœ… ì´ë¯¸ ì™„ë£Œëœ ì‘ì—…');
        // ì™„ë£Œ ë²„íŠ¼ì´ ì´ë¯¸ ë Œë”ë§ë˜ì–´ ìˆìŒ
    } else {
        // ì¦‰ì‹œ ì—…ë°ì´íŠ¸ + 1ì´ˆë§ˆë‹¤ í´ë§
        updateProgress();
        pollInterval = setInterval(updateProgress, 1000);
        console.log('ğŸ”„ í´ë§ ì‹œì‘ (1ì´ˆ ê°„ê²©)');
    }
});

// í˜ì´ì§€ ì–¸ë¡œë“œ ì‹œ í´ë§ ì •ë¦¬
window.addEventListener('beforeunload', function() {
    if (pollInterval) {
        clearInterval(pollInterval);
        console.log('ğŸ›‘ í´ë§ ì¤‘ì§€');
    }
});
</script>

{% endblock %}